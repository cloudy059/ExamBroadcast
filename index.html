<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒè¯•ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 60px;
            position: relative;
        }

        .title {
            font-size: 2.5em;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .control-buttons {
            position: absolute;
            top: 70px;
            right: 0;
            display: flex;
            gap: 8px;
        }

        .control-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }

        .control-btn.active {
            background: rgba(255,255,255,0.4);
            border-color: rgba(255,255,255,0.6);
        }

        .time-display {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 10px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .time-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .time-item {
            text-align: center;
            padding: 15px;
            background: rgba(103, 126, 234, 0.1);
            border-radius: 10px;
            border: 2px solid rgba(103, 126, 234, 0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 120px;
        }

        .time-label {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .time-value {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(to bottom, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            line-height: 1.2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .progress-single {
            margin-top: 10px;
            transition: background-image 0.3s ease;
        }



        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .section {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .section-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            margin: 2px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.8em;
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        }

        .btn-success {
            background: linear-gradient(45deg, #51cf66, #40c057);
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffd43b, #fab005);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .exam-item, .reminder-item {
            background: rgba(103, 126, 234, 0.05);
            border: 2px solid rgba(103, 126, 234, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: move;
            transition: all 0.3s ease;
        }

        .exam-item:hover, .reminder-item:hover {
            border-color: rgba(103, 126, 234, 0.3);
            transform: translateY(-2px);
        }

        .exam-item.dragging, .reminder-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-title {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }

        .item-details {
            color: #666;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-upcoming {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-ongoing {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status-finished {
            background: #fce4ec;
            color: #c2185b;
        }

        .controls {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1003;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .file-input {
            display: none;
        }

        .file-label {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .file-label:hover {
            transform: translateY(-2px);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .import-export {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #f44336;
        }

        .seating-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1002;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .seating-notification.show {
            transform: translateX(0);
        }

        .seating-notification.error {
            background: #f44336;
        }

        .seating-notification.warning {
            background: #ff9800;
        }

        .drag-over {
            border-color: #667eea !important;
        }

        .dragging {
            background: rgba(103, 126, 234, 0.1) !important;
        }

        /* å¤œé—´æ¨¡å¼æ ·å¼ */
        body.dark-mode {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        }

        body.dark-mode .time-display,
        body.dark-mode .section {
            background: rgba(52, 73, 94, 0.95);
            color: #ecf0f1;
        }

        body.dark-mode .time-item {
            background: rgba(52, 73, 94, 0.3);
            border-color: rgba(52, 73, 94, 0.5);
        }

        body.dark-mode .time-label {
            color: #3498db;
        }

        body.dark-mode .section-title {
            color: #3498db;
        }

        body.dark-mode .form-group label {
            color: #bdc3c7;
        }

        body.dark-mode .form-group input,
        body.dark-mode .form-group select {
            background: rgba(52, 73, 94, 0.8);
            border-color: rgba(52, 73, 94, 0.5);
            color: #ecf0f1;
        }

        body.dark-mode .exam-item,
        body.dark-mode .reminder-item {
            background: rgba(52, 73, 94, 0.3);
            border: 2px solid #00d4ff;
            border-radius: 12px;
            color: #ecf0f1;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.4), inset 0 0 10px rgba(0, 212, 255, 0.1);
            transition: all 0.3s ease;
        }

        body.dark-mode .exam-item:hover,
        body.dark-mode .reminder-item:hover {
            border-color: #00f5ff;
            box-shadow: 0 0 25px rgba(0, 245, 255, 0.6), inset 0 0 15px rgba(0, 245, 255, 0.2);
            transform: translateY(-3px);
        }

        body.dark-mode .item-title {
            color: #ecf0f1;
        }

        body.dark-mode .item-details {
            color: #bdc3c7;
        }

        /* å…¨å±æ¨¡å¼æ ·å¼ */
        body.fullscreen-mode .header {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1002;
            margin-bottom: 0px;
            width: 100%;
            max-width: 1100px;
        }

        body.fullscreen-mode .main-content {
            display: none;
        }

        body.fullscreen-mode .seating-content {
            display: none;
        }

        body.fullscreen-mode .seating-content.active {
            display: block;
            position: fixed;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 1100px;
            z-index: 1001;
            padding: 25px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0ï¼Œ 0, 0, 0.1);
        }

        body.fullscreen-mode .time-display {
            position: fixed;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 1100px;
            z-index: 1000;
            padding: 25px;
            box-sizing: border-box;
        }

        /* å…¨å±æ¨¡å¼ä¸‹éšè—æ—¶é—´æ˜¾ç¤ºçš„ç±» */
        body.fullscreen-mode .time-display.hidden {
            display: none;
        }

        bodyã€‚fullscreen-mode ã€‚time-grid {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        bodyã€‚fullscreen-mode ã€‚time-item {
            min-height: 120px;
            padding: 15px;
            overflow: hidden;
        }

        bodyã€‚fullscreen-mode ã€‚time-label {
            font-size: 1.8em;
        }

        body.fullscreen-mode .time-value {
            font-size: 2.5em;
            line-height: 1.2;
        }

        body.fullscreen-mode .control-buttons {
            position: fixed;
            top: 60px;
            right: 20px;
            z-index: 1001;
        }

        ã€‚fullscreen-exam-list {
            margin-top: 15px;
            padding: 20px;
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            overflow-y: visible;
        }

        .exam-list-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .exam-list-title::before {
            content: "ğŸ“…";
            font-size: 1.2em;
        }

        .exam-list-content {
            overflow-y: visible;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 15px;
        }

        body.fullscreen-mode .fullscreen-exam-list {
            display: block !important;
        }

        body.dark-mode .exam-list-title {
            color: #3498db;
        }

        body.dark-mode .fullscreen-exam-list {
            background: rgba(52, 73, 94, 0.95);
            color: #ecf0f1;
        }

        body.dark-mode .time-label {
            color: #00f5ff;
            text-shadow: 0 0 10px rgba(0, 245, 255, 0.6);
        }

        body.dark-mode .time-value {
            background: linear-gradient(45deg, #00f5ff, #ff1493, #ffd700, #00ff00, #8a2be2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 300% 300%;
            animation: rainbow-glow 3s ease-in-out infinite;
            text-shadow: 0 0 20px rgba(255, 20, 147, 0.8), 0 0 30px rgba(0, 245, 255, 0.6), 0 0 40px rgba(255, 215, 0, 0.4);
            filter: drop-shadow(0 0 15px rgba(138, 43, 226, 0.7));
        }

        @keyframes rainbow-glow {
            0% {
                background-position: 0% 50%;
                filter: drop-shadow(0 0 15px rgba(138, 43, 226, 0.7)) brightness(1.2);
            }
            50% {
                background-position: 100% 50%;
                filter: drop-shadow(0 0 25px rgba(255, 20, 147, 0.9)) brightness(1.5);
            }
            100% {
                background-position: 0% 50%;
                filter: drop-shadow(0 0 15px rgba(138, 43, 226, 0.7)) brightness(1.2);
            }
        }

        body.dark-mode .time-item {
            background: rgba(52, 73, 94, 0.3);
            border-color: rgba(116, 192, 252, 0.3);
        }

        body.dark-mode .time-display {
            background: rgba(52, 73, 94, 0.95);
        }

        body.dark-mode .title {
            background: linear-gradient(45deg, #00f5ff, #ff1493, #ffd700, #00ff00, #8a2be2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 300% 300%;
            animation: rainbow-glow 3s ease-in-out infinite;
            text-shadow: 0 0 20px rgba(255, 20, 147, 0.8), 0 0 30px rgba(0, 245, 255, 0.6), 0 0 40px rgba(255, 215, 0, 0.4);
            filter: drop-shadow(0 0 15px rgba(138, 43, 226, 0.7));
        }

        /* ç¼©æ”¾æ ·å¼ */
        .zoom-75 {
            transform: scale(0.75);
            transform-origin: top center;
        }

        .zoom-90 {
            transform: scale(0.9);
            transform-origin: top center;
        }

        .zoom-110 {
            transform: scale(1.1);
            transform-origin: top center;
        }

        .zoom-125 {
            transform: scale(1.25);
            transform-origin: top center;
        }

        .zoom-150 {
            transform: scale(1.5);
            transform-origin: top center;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .control-buttons {
                position: static;
                justify-content: center;
                margin-top: 10px;
            }

            /* æ™®é€šæ¨¡å¼ä¸‹çš„æ‰‹æœºé€‚é… */
            .time-display {
                padding: 15px;
            }

            .time-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .time-item {
                min-height: 100px;
                padding: 12px;
            }

            .time-label {
                font-size: 1.3em;
            }

            .time-value {
                font-size: 1.8em;
                line-height: 1.1;
                word-break: break-all;
            }

            /* å…¨å±æ¨¡å¼ä¸‹çš„æ‰‹æœºé€‚é… */
            body.fullscreen-mode .time-display {
                width: 95vw;
                padding: 20px;
            }

            body.fullscreen-mode .time-label {
                font-size: 1.2em;
            }

            body.fullscreen-mode .time-value {
                font-size: 1.8em;
                line-height: 1.1;
            }

            body.fullscreen-mode .time-item {
                min-height: 120px;
                padding: 15px;
            }

            body.fullscreen-mode .exam-list-content {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        /* é¢å¤–å°å±å¹•é€‚é… (å°äº480px) */
        @media (max-width: 480px) {
            .time-display {
                padding: 10px;
            }

            .time-item {
                min-height: 80px;
                padding: 8px;
            }

            .time-label {
                font-size: 1.1em;
            }

            .time-value {
                font-size: 1.5em;
                line-height: 1.0;
            }

            body.fullscreen-mode .time-value {
                font-size: 1.5em;
            }

            body.fullscreen-mode .time-label {
                font-size: 1.0em;
            }
        }

        /* è€ƒåœºå®‰æ’é¡µé¢æ ·å¼ */
        .seating-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0px;
            display: none;
        }

        .seating-content.active {
            display: block;
        }

        .main-content.hidden {
            display: none;
        }

        .time-display.hidden {
            display: none;
        }

        .import-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.12);
            white-space: nowrap;
        }

        .import-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .clear-data-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.12);
            margin-left: 10px;
            white-space: nowrap;
        }

        .clear-data-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .seating-arrangement {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            min-height: 400px;
        }

        .no-data {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: #999;
            font-size: 1.1em;
        }

        .no-data i {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .seating-stats {
            margin-left: auto;
            display: flex;
            gap: 15px;
            font-size: 0.9em;
            color: #666;
        }

        .stat-item {
            background: rgba(103, 126, 234, 0.1);
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: 500;
        }

        .seating-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
            align-items: end;
        }

        .seating-group {
            background: rgba(103, 126, 234, 0.05);
            border: 2px solid rgba(103, 126, 234, 0.2);
            border-radius: 8px;
            padding: 8px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: stretch;
        }

        .group-header {
            background: #667eea;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: bold;
            text-align: center;
            order: 2;
            margin-top: 8px;
            margin-bottom: 0;
        }

        .seats-container {
            display: flex;
            flex-direction: column-reverse;
            gap: 6px;
            min-height: 200px;
            align-items: center;
            justify-content: flex-end;
            order: 1;
        }

        .seat {
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            padding: 6px 12px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            width: 150px;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
        }

        .seat:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .seat-number {
            font-size: 1.1em;
            color: #667eea;
            font-weight: bold;
            margin-right: 8px;
        }

        .student-name {
            font-weight: bold;
            color: #333;
            font-size: 1.3em;
        }

        /* åº§ä½æ§åˆ¶åŒºåŸŸæ ·å¼ */
        .seating-controls {
            display: flex;
            gap: 8px;
            margin: 15px 0;
            flex-wrap: nowrap;
            align-items: center;
            justify-content: flex-start;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
        }

        .control-group label {
            font-weight: 500;
            font-size: 0.8em;
            white-space: nowrap;
            min-width: fit-content;
        }

        .control-group input {
            padding: 4px 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .control-group input[type="text"] {
            width: 90px;
        }

        .control-group input[type="number"] {
            width: 50px;
        }

        .control-group input#groupSizes {
            width: 85px;
            font-size: 18px;
        }

        /* ç‰¹å®šè¾“å…¥æ¡†çš„å®½åº¦è°ƒæ•´ */
        #queryTypeSelect {
            width: 80px !important;
            margin-right: 5px;
            font-size: 18px;
        }

        #queryInput {
            width: 80px !important;
        }

        #groupSizes {
            width: 160px !important;        
            font-size: 14px;
        }

        /* ç­çº§å­¦ç”Ÿç½‘æ ¼æ˜¾ç¤ºæ ·å¼ */
        .class-students-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
            padding: 10px;
        }

        .class-student-item {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 8px 10px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            min-width: 0;
        }

        .class-student-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.12);
        }

        .class-student-item .student-name {
            font-weight: bold;
            color: #2c3e50;
            flex-shrink: 0;
            font-size: 16px;
        }

        .class-student-item .class-seat-number {
            color: #3498db;
            font-weight: bold;
            font-size: 16px;
            margin-right: 4px;
        }

        .class-student-item .exam-seat {
            color: #e74c3c;
            white-space: nowrap;
            font-weight: bold;
            font-size: 16px;
        }

        /* å¤œé—´æ¨¡å¼ä¸‹çš„è€ƒåœºå®‰æ’æ ·å¼ */
        body.dark-mode .seating-arrangement {
            background: rgba(52, 73, 94, 0.95);
            color: #ecf0f1;
        }

        body.dark-mode .control-group label {
            color: #ecf0f1;
        }

        body.dark-mode .control-group input {
            background-color: #2c3e50;
            border-color: rgba(116, 192, 252, 0.3);
            color: #ecf0f1;
        }

        body.dark-mode select {
            background: rgba(52, 73, 94, 0.9);
            color: #ecf0f1;
            border-color: rgba(116, 192, 252, 0.3);
        }

        /* ç­çº§å­¦ç”Ÿç½‘æ ¼çš„dark modeæ ·å¼ */
        body.dark-mode .class-student-item {
            background: rgba(44, 62, 80, 0.95);
            border-color: rgba(116, 192, 252, 0.3);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .class-student-item:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }

        body.dark-mode .class-student-item .student-name {
            color: #ecf0f1;
        }

        body.dark-mode .class-student-item .class-seat-number {
            color: #74c0fc;
        }

        body.dark-mode .class-student-item .exam-seat {
            color: #ff6b6b;
        } 

        body.dark-mode .seat {
            background: rgba(44, 62, 80, 0.8);
            border-color: rgba(116, 192, 252, 0.3);
            color: #ecf0f1;
        }

        body.dark-mode .seating-group {
            background: rgba(52, 73, 94, 0.3);
            border-color: rgba(116, 192, 252, 0.3);
        }

        body.dark-mode .student-name {
            color: #ecf0f1;
        }

        body.dark-mode .seat-number {
            color: #3498db;
        }

        body.dark-mode .group-header {
            background: #3498db;
        }

        body.dark-mode .seating-stats {
            color: #bdc3c7;
        }

        body.dark-mode .stat-item {
            background: rgba(52, 158, 218, 0.2);
        }

        body.dark-mode .no-data {
            color: #7f8c8d;
        }

        /* å…¨å±æ¨¡å¼ä¸‹çš„å¤œé—´æ¨¡å¼è€ƒåœºå®‰æ’æ ·å¼ */
        body.fullscreen-mode.dark-mode .seating-arrangement {
            background: rgba(52, 73, 94, 0.95);
        }

        body.fullscreen-mode.dark-mode .seating-content.active {
            background: rgba(52, 73, 94, 0.95);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title" id="examTitle">è€ƒè¯•ç®¡ç†ç³»ç»Ÿ</h1>
            <div class="control-buttons">
                <button class="control-btn" onclick="togglePage()" title="è€ƒåœºå®‰æ’" id="pageToggleBtn">
                    <i class="fas fa-th"></i>
                </button>
                <button class="control-btn" onclick="zoomOut()" title="ç¼©å°">
                    <i class="fas fa-search-minus"></i>
                </button>

                <button class="control-btn" onclick="zoomIn()" title="æ”¾å¤§">
                    <i class="fas fa-search-plus"></i>
                </button>
                <button class="control-btn" onclick="showHelp()" title="å¸®åŠ©">
                    <i class="fas fa-question-circle"></i>
                </button>
                <button class="control-btn" onclick="exportConfig()" title="å¯¼å‡ºé…ç½®">
                    <i class="fas fa-download"></i>
                </button>
                <label class="control-btn" title="å¯¼å…¥é…ç½®" style="cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-upload"></i>
                    <input type="file" class="file-input" accept=".json" onchange="importConfig(event)" style="display: none;">
                </label>
                <button class="control-btn" onclick="toggleDarkMode()" title="å¤œé—´æ¨¡å¼" id="darkModeBtn">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="control-btn" onclick="toggleFullscreen()" title="å…¨å±æ¨¡å¼" id="fullscreenBtn">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="control-btn" onclick="toggleLock()" title="é”å®š/è§£é”" id="lockBtn">
                    <i class="fas fa-lock"></i>
                </button>
            </div>
        </div>

        <div class="time-display">
            <div class="time-grid">
                <div class="time-item">
                    <div class="time-label"></div>
                    <div class="time-value" id="currentTime">--:--:--</div>
                </div>
                <div class="time-item">
                    <div class="time-label" id="countdownLabel"></div>
                    <div class="time-value" id="countdown">--</div>
                </div>
            </div>
            <div class="fullscreen-exam-list" id="fullscreenExamList" style="display: none;">
                <div class="exam-list-content" id="fullscreenExamListContent"></div>
            </div>
        </div>

        <div class="main-content" id="mainContent">
            <div class="section">
                <div class="section-title">
                    <i class="fas fa-calendar-alt"></i>
                    è€ƒè¯•ç®¡ç†
                    <button class="btn btn-success btn-small" onclick="addExam()" style="margin-left: auto;">
                        <i class="fas fa-plus"></i> æ·»åŠ è€ƒè¯•
                    </button>
                </div>

                <div id="examList"></div>
            </div>

            <div class="section">
                <div class="section-title">
                    <i class="fas fa-bell"></i>
                    æé†’è®¾ç½®
                    <button class="btn btn-success btn-small" onclick="addReminder()" style="margin-left: auto;">
                        <i class="fas fa-plus"></i> æ·»åŠ æé†’
                    </button>
                </div>

                <div id="reminderList"></div>
            </div>
        </div>

        <!-- è€ƒåœºå®‰æ’é¡µé¢ -->
        <div class="seating-content" id="seatingContent" style="display: none;">
            <div class="section">
                <div class="section-title">
                    <i class="fas fa-th"></i>
                    è€ƒåœºå®‰æ’
                    <label class="import-btn">
                        <i class="fas fa-upload"></i>
                        å¯¼å…¥æ•°æ®
                        <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleExcelImport(event)" style="display: none;">
                    </label>
                    <button class="clear-data-btn" onclick="clearStudentsData()" title="æ¸…é™¤å·²å¯¼å…¥çš„å­¦ç”Ÿæ•°æ®">
                        <i class="fas fa-trash"></i>
                        æ¸…é™¤æ•°æ®
                    </button>
                    <div class="seating-controls">
                        <div class="control-group">
                            <select id="queryTypeSelect" onchange="updateQueryType()">
                                <option value="examRoom">è€ƒåœº</option>
                                <option value="class">ç­çº§</option>
                            </select>
                            <input type="text" id="queryInput" placeholder="å¦‚ï¼š101" onchange="performQuery()">
                        </div>
                        <div class="control-group">
                            <label for="groupCount">ç»„æ•°ï¼š</label>
                            <input type="number" id="groupCount" value="5" min="1" max="10" onchange="updateGroupSettings()">
                        </div>
                        <div class="control-group">
                            <label for="groupSizes">å„ç»„äººæ•°ï¼š</label>
                            <input type="text" id="groupSizes" placeholder="å¦‚ï¼š6,7,7,7,7" onchange="updateSeatingConfig(); const queryType = document.getElementById('queryTypeSelect').value; if (queryType === 'examRoom') { updateSeatingArrangement(); }">
                        </div>
                    </div>
                    <div class="seating-stats" id="seatingStats"></div>
                </div>
                <div class="seating-arrangement" id="seatingArrangement">
                    <div class="no-data">
                        <i class="fas fa-users"></i>
                        <p>è¯·ç‚¹å‡»"å¯¼å…¥æ•°æ®"æŒ‰é’®é€‰æ‹©Excelæ–‡ä»¶</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è€ƒè¯•ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="examModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeExamModal()">&times;</span>
            <h2 id="examModalTitle">æ·»åŠ è€ƒè¯•</h2>
            <form id="examForm">
                <div class="form-group">
                    <label for="examSubject">ç§‘ç›®:</label>
                    <input type="text" id="examSubject" required>
                </div>
                <div class="form-group">
                    <label for="examDate">æ—¥æœŸ:</label>
                    <input type="date" id="examDate" required>
                </div>
                <div class="form-group">
                    <label for="examStartTime">å¼€å§‹æ—¶é—´:</label>
                    <input type="time" id="examStartTime" required>
                </div>
                <div class="form-group">
                    <label for="examDuration">æ—¶é•¿(åˆ†é’Ÿ):</label>
                    <input type="number" id="examDuration" min="1" required>
                </div>
                <div class="form-group">
                    <label for="examRecurrence">å¾ªç¯è®¾ç½®:</label>
                    <select id="examRecurrence" onchange="updateRecurrenceSettings()" required>
                        <option value="once">ä¸€æ¬¡</option>
                        <option value="daily">æ¯å¤©</option>
                        <option value="weekly">æ¯å‘¨</option>
                        <option value="monthly">æ¯æœˆ</option>
                    </select>
                </div>
                <div class="form-group" id="recurrenceEndGroup" style="display: none;">
                    <label for="recurrenceEndDate">å¾ªç¯ç»“æŸæ—¥æœŸ:</label>
                    <input type="date" id="recurrenceEndDate">
                    <small style="color: #666; font-size: 0.8em; margin-top: 5px; display: block;">ç•™ç©ºè¡¨ç¤ºæ— é™å¾ªç¯</small>
                </div>
                <div class="form-group">
                    <label>ç»“æŸæ—¶é—´:</label>
                    <div id="examEndTime">--:--</div>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> ä¿å­˜
                    </button>
                    <button type="button" class="btn" onclick="closeExamModal()">
                        <i class="fas fa-times"></i> å–æ¶ˆ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- æé†’ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="reminderModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeReminderModal()">&times;</span>
            <h2 id="reminderModalTitle">æ·»åŠ æé†’</h2>
            <form id="reminderForm">
                <div class="form-group">
                    <label for="reminderType">æé†’ç±»å‹:</label>
                    <select id="reminderType" onchange="updateReminderForm()" required>
                        <option value="å¼€è€ƒå‰">å¼€è€ƒå‰</option>
                        <option value="ç»“æŸå‰">ç»“æŸå‰</option>
                        <option value="å¼€å§‹è€ƒè¯•">å¼€å§‹è€ƒè¯•</option>
                        <option value="è€ƒè¯•ç»“æŸ">è€ƒè¯•ç»“æŸ</option>
                    </select>
                </div>
                <div class="form-group" id="minutesGroup">
                    <label for="reminderMinutes">æå‰æ—¶é—´(åˆ†é’Ÿ):</label>
                    <input type="number" id="reminderMinutes" min="1" value="15">
                </div>
                <div class="form-group">
                    <label for="reminderSound">é“ƒå£°:</label>
                    <select id="reminderSound" required>
                        <option value="">é€‰æ‹©é“ƒå£°</option>
                    </select>
                    <div class="audio-controls">
                        <button type="button" class="btn btn-small" onclick="playSound()">
                            <i class="fas fa-play"></i> è¯•å¬
                        </button>
                        <label class="btn btn-small" style="color: white;">
                            <i class="fas fa-upload"></i> å¯¼å…¥
                            <input type="file" class="file-input" accept="audio/*" onchange="importAudio(event)">
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> ä¿å­˜
                    </button>
                    <button type="button" class="btn" onclick="closeReminderModal()">
                        <i class="fas fa-times"></i> å–æ¶ˆ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- å¸®åŠ©æ¨¡æ€æ¡† -->
    <div id="helpModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeHelpModal()">&times;</span>
            <h2>ğŸ“š è€ƒè¯•ç®¡ç†ç³»ç»Ÿä½¿ç”¨å¸®åŠ©</h2>
            
            <div style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
                <h3>ğŸ“… è€ƒè¯•ç®¡ç†</h3>
                <ul>
                    <li><strong>æ·»åŠ è€ƒè¯•</strong>ï¼šç‚¹å‡»â€œæ·»åŠ è€ƒè¯•â€æŒ‰é’®ï¼Œå¡«å†™ç§‘ç›®ã€æ—¥æœŸã€æ—¶é—´ã€æ—¶é•¿å’Œå¾ªç¯è®¾ç½®</li>
                    <li><strong>å¾ªç¯è€ƒè¯•</strong>ï¼šæ”¯æŒä¸€æ¬¡ã€æ¯å¤©ã€æ¯å‘¨ã€æ¯æœˆå¾ªç¯ï¼Œå¯è®¾ç½®ç»“æŸæ—¥æœŸ</li>
                    <li><strong>ç¼–è¾‘è€ƒè¯•</strong>ï¼šç‚¹å‡»ç¼–è¾‘æŒ‰é’®ä¿®æ”¹è€ƒè¯•ä¿¡æ¯ï¼Œä¿®æ”¹åæ‰€æœ‰å¾ªç¯å®ä¾‹éƒ½ä¼šæ›´æ–°</li>
                    <li><strong>åˆ é™¤è€ƒè¯•</strong>ï¼šç‚¹å‡»åˆ é™¤æŒ‰é’®åˆ é™¤è€ƒè¯•ï¼Œå¾ªç¯è€ƒè¯•ä¼šåˆ é™¤æ•´ä¸ªç³»åˆ—</li>
                </ul>

                <h3>ğŸ”” æé†’è®¾ç½®</h3>
                <ul>
                    <li><strong>å¼€è€ƒå‰</strong>ï¼šåœ¨è€ƒè¯•å¼€å§‹å‰æŒ‡å®šæ—¶é—´æé†’</li>
                    <li><strong>ç»“æŸå‰</strong>ï¼šåœ¨è€ƒè¯•ç»“æŸå‰æŒ‡å®šæ—¶é—´æé†’</li>
                    <li><strong>å¼€å§‹è€ƒè¯•</strong>ï¼šè€ƒè¯•å¼€å§‹æ—¶ç«‹å³æé†’</li>
                    <li><strong>è€ƒè¯•ç»“æŸ</strong>ï¼šè€ƒè¯•ç»“æŸæ—¶ç«‹å³æé†’</li>
                    <li><strong>è‡ªå®šä¹‰é“ƒå£°</strong>ï¼šå¯å¯¼å…¥éŸ³é¢‘æ–‡ä»¶ä½œä¸ºæé†’é“ƒå£°</li>
                </ul>

                <h3>ğŸ”„ å¾ªç¯ç±»å‹è¯´æ˜</h3>
                <ul>
                    <li><strong>ä¸€æ¬¡</strong>ï¼šä¼ ç»Ÿçš„ä¸€æ¬¡æ€§è€ƒè¯•</li>
                    <li><strong>æ¯å¤©</strong>ï¼šæ¯å¤©åŒä¸€æ—¶é—´é‡å¤è€ƒè¯•</li>
                    <li><strong>æ¯å‘¨</strong>ï¼šæ¯å‘¨åŒä¸€æ˜ŸæœŸå‡ é‡å¤è€ƒè¯•</li>
                    <li><strong>æ¯æœˆ</strong>ï¼šæ¯æœˆåŒä¸€æ—¥æœŸé‡å¤è€ƒè¯•</li>
                    <li><strong>ç»“æŸæ—¥æœŸ</strong>ï¼šå¯é€‰è®¾ç½®ï¼Œç•™ç©ºè¡¨ç¤ºæ— é™å¾ªç¯</li>
                </ul>

                <h3>â±ï¸ æ—¶é—´æ˜¾ç¤º</h3>
                <ul>
                    <li><strong>å½“å‰æ—¶é—´</strong>ï¼šå®æ—¶æ˜¾ç¤ºç³»ç»Ÿæ—¶é—´å’Œæ—¥æœŸ</li>
                    <li><strong>è€ƒè¯•å€’è®¡æ—¶</strong>ï¼šæ˜¾ç¤ºè·ç¦»ä¸‹ä¸€åœºè€ƒè¯•çš„å‰©ä½™æ—¶é—´</li>
                    <li><strong>è€ƒè¯•è¿›åº¦</strong>ï¼šè€ƒè¯•è¿›è¡Œä¸­æ˜¾ç¤ºå·²è¿›è¡Œå’Œå‰©ä½™æ—¶é—´</li>
                </ul>

                <h3>ğŸ® åŠŸèƒ½æŒ‰é’®</h3>
                <ul>
                    <li><strong>ç¼©æ”¾</strong>ï¼šç‚¹å‡»æ”¾å¤§é•œã€ç¼©å°é•œè°ƒæ•´é¡µé¢å¤§å°</li>
                    <li><strong>å¯¼å‡º/å¯¼å…¥</strong>ï¼šä¿å­˜å’Œè½½å…¥è€ƒè¯•é…ç½®æ–‡ä»¶</li>
                    <li><strong>å¤œé—´æ¨¡å¼</strong>ï¼šåˆ‡æ¢æ·±è‰²ä¸»é¢˜ï¼Œä¿æŠ¤çœ¼ç›</li>
                    <li><strong>å…¨å±æ¨¡å¼</strong>ï¼šéšè—ç®¡ç†ç•Œé¢ï¼Œä¸“æ³¨æ˜¾ç¤ºæ—¶é—´å’Œè€ƒè¯•ä¿¡æ¯</li>
                </ul>

                <h3>âŒ¨ï¸ å¿«æ·é”®</h3>
                <ul>
                    <li><strong>Ctrl + åŠ å·</strong>ï¼šæ”¾å¤§é¡µé¢</li>
                    <li><strong>Ctrl + å‡å·</strong>ï¼šç¼©å°é¡µé¢</li>
                    <li><strong>Ctrl + 0</strong>ï¼šé‡ç½®ç¼©æ”¾</li>
                    <li><strong>F11</strong>ï¼šåˆ‡æ¢å…¨å±æ¨¡å¼</li>
                    <li><strong>Ctrl + D</strong>ï¼šåˆ‡æ¢å¤œé—´æ¨¡å¼</li>
                </ul>

                <h3>ğŸª‘ è€ƒåœºå®‰æ’</h3>
                <ul>
                    <li><strong>å¯¼å…¥æ•°æ®</strong>ï¼šè¡¨å¤´åŒ…å«ç­çº§ã€ç­çº§åº§å·ã€å§“åã€è€ƒåœºã€åº§å·ç­‰ä¿¡æ¯</li>                   
                    <li><strong>è€ƒåœºæŸ¥è¯¢</strong>ï¼šè¾“å…¥è€ƒåœºå·æŸ¥çœ‹è¯¥è€ƒåœºçš„å­¦ç”Ÿåº§ä½å®‰æ’ï¼ŒæŒ‰åº§å·å‡åºæ˜¾ç¤º</li>
                    <li><strong>ç­çº§æŸ¥è¯¢</strong>ï¼šåˆ‡æ¢åˆ°ç­çº§æ¨¡å¼ï¼Œè¾“å…¥ç­çº§å·æŸ¥çœ‹ç­çº§çš„å­¦ç”Ÿåº§ä½å®‰æ’</li>                    
                    <li><strong>æ¸…é™¤æ•°æ®</strong>ï¼šå¯ä¸€é”®æ¸…é™¤æ‰€æœ‰å·²å¯¼å…¥çš„è€ƒåœºå®‰æ’æ•°æ®</li>                   
                </ul>

                <h3>ğŸ’¾ æ•°æ®ä¿å­˜</h3>
                <ul>
                    <li>æ‰€æœ‰è€ƒè¯•å’Œæé†’è®¾ç½®è‡ªåŠ¨ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­</li>
                    <li>å¯é€šè¿‡å¯¼å‡ºåŠŸèƒ½å¤‡ä»½é…ç½®æ–‡ä»¶</li>
                    <li>æ”¯æŒåœ¨ä¸åŒè®¾å¤‡é—´å¯¼å…¥å¯¼å‡ºé…ç½®</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // å…¨å±€å˜é‡
        let config = {
            title: 'è€ƒè¯•ç®¡ç†ç³»ç»Ÿ',
            exams: [],
            reminders: []
        };
        let currentEditingExam = null;
        let currentEditingReminder = null;
        let availableSounds = [];
        let customSounds = {};
        let currentAudio = null;
        let reminderCheckInterval = null;
        let playedReminders = new Set();
        let audioQueue = [];
        let isPlayingAudio = false;
        let pendingDelayedReminders = [];

        // è€ƒåœºå®‰æ’ç›¸å…³å˜é‡
        let studentsData = [];
        let currentExamRoom = '';
        let seatingConfig = {
            examRoom: '',
            groupCount: 5,
            groupSizes: '6,6,6,6,6',
            seatingResult: null
        };
        let currentPage = 'main'; // 'main' æˆ– 'seating'

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            loadSounds();
            updateDisplay();
            startTimeUpdate();
            startReminderCheck();
            loadSettings();
            loadClassStudentsFromStorage(); // æ¢å¤ç­çº§å­¦ç”Ÿä¿¡æ¯
            loadExamRoomFromStorage(); // æ¢å¤è€ƒåœºä¿¡æ¯
        });

        // åŠ è½½é…ç½®
        async function loadConfig() {
            try {
                const response = await fetch('./exam_config.json');
                if (response.ok) {
                    const data = await response.json();
                    config = { ...config, ...data };
                    
                    // ä»localStorageåŠ è½½ä¿å­˜çš„æ•°æ®
                    const savedConfig = localStorage.getItem('examConfig');
                    if (savedConfig) {
                        const parsed = JSON.parse(savedConfig);
                        config = { ...config, ...parsed };
                    }
                }
            } catch (error) {
                console.log('åŠ è½½é…ç½®æ–‡ä»¶å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®');
                loadFromLocalStorage();
            }
            
            updateDisplay();
        }

        // ä»localStorageåŠ è½½
        function loadFromLocalStorage() {
            const savedConfig = localStorage.getItem('examConfig');
            if (savedConfig) {
                config = { ...config, ...JSON.parse(savedConfig) };
            }
        }

        // ä¿å­˜åˆ°localStorage
        function saveToLocalStorage() {
            localStorage.setItem('examConfig', JSON.stringify(config));
        }

        // åŠ è½½éŸ³é¢‘æ–‡ä»¶
        async function loadSounds() {
            const defaultSounds = [
                'before15.mp3', 'before20.mp3', 'before5.mp3',
                'end.mp3', 'end15.mp3', 'start.mp3'
            ];
            
            availableSounds = [];
            
            for (const sound of defaultSounds) {
                try {
                    const response = await fetch(`./sounds/${sound}`);
                    if (response.ok) {
                        availableSounds.push(sound);
                    }
                } catch (error) {
                    console.log(`éŸ³é¢‘æ–‡ä»¶ ${sound} ä¸å­˜åœ¨`);
                }
            }
            
            // åŠ è½½è‡ªå®šä¹‰éŸ³é¢‘
            const savedSounds = localStorage.getItem('customSounds');
            if (savedSounds) {
                customSounds = JSON.parse(savedSounds);
                availableSounds.push(...Object.keys(customSounds));
            }
            
            updateSoundOptions();
        }

        // æ›´æ–°éŸ³é¢‘é€‰é¡¹
        function updateSoundOptions() {
            const select = document.getElementById('reminderSound');
            select.innerHTML = '<option value="">é€‰æ‹©é“ƒå£°</option>';
            
            availableSounds.forEach(sound => {
                const option = document.createElement('option');
                option.value = sound;
                option.textContent = sound;
                select.appendChild(option);
            });
        }

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            document.getElementById('examTitle').textContent = config.title;
            updateExamList();
            updateReminderList();
        }

        // æ›´æ–°è€ƒè¯•åˆ—è¡¨
        function updateExamList() {
            const examList = document.getElementById('examList');
            examList.innerHTML = '';
            
            // è·å–æ‰€æœ‰è€ƒè¯•å®ä¾‹ï¼ˆåŒ…å«å¾ªç¯ç”Ÿæˆçš„ï¼‰
            const allInstances = getAllExamInstances();
            
            allInstances.forEach((exam, displayIndex) => {
                const examItem = document.createElement('div');
                examItem.className = 'exam-item';
                examItem.draggable = true;
                examItem.dataset.index = exam.originalIndex; // ä½¿ç”¨åŸå§‹ç´¢å¼•ç”¨äºç¼–è¾‘å’Œåˆ é™¤
                
                const status = getExamStatus(exam);
                const endTime = calculateEndTime(exam.startTime, exam.duration);
                
                examItem.innerHTML = `
                    <div class="item-header">
                        <div class="item-title">${exam.subject}</div>
                        <div class="controls">
                            <span class="status-badge status-${status.class}">${status.text}</span>
                            <button class="btn btn-small exam-edit-btn" onclick="editExam(${exam.originalIndex})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-small btn-danger exam-delete-btn" onclick="deleteExam(${exam.originalIndex})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="item-details">
                        æ—¥æœŸ: ${exam.date} | æ—¶é—´: ${exam.startTime} - ${endTime} | æ—¶é•¿: ${exam.duration}åˆ†é’Ÿ | å¾ªç¯: ${getRecurrenceText(exam.recurrence, exam.recurrenceEndDate)}
                    </div>
                `;
                
                // æ‹–æ‹½äº‹ä»¶ï¼ˆåªå…è®¸æ‹–æ‹½åŸå§‹è€ƒè¯•ï¼Œä¸å…è®¸æ‹–æ‹½ç”Ÿæˆçš„å®ä¾‹ï¼‰
                if (exam.instanceIndex === undefined || exam.instanceIndex === 0) {
                    examItem.addEventListener('dragstart', handleDragStart);
                    examItem.addEventListener('dragover', handleDragOver);
                    examItem.addEventListener('drop', handleDrop);
                    examItem.addEventListener('dragend', handleDragEnd);
                } else {
                    examItem.draggable = false;
                    examItem.style.opacity = '0.8';
                }
                
                examList.appendChild(examItem);
            });
            
            // æ›´æ–°é”å®šçŠ¶æ€ï¼ˆç¡®ä¿æ–°ç”Ÿæˆçš„æŒ‰é’®ä¹Ÿå—é”å®šæ§åˆ¶ï¼‰
            updateLockState();
        }

        // æ›´æ–°æé†’åˆ—è¡¨
        function updateReminderList() {
            const reminderList = document.getElementById('reminderList');
            reminderList.innerHTML = '';
            
            config.reminders.forEach((reminder, index) => {
                const reminderItem = document.createElement('div');
                reminderItem.className = 'reminder-item';
                reminderItem.draggable = true;
                reminderItem.dataset.index = index;
                
                const minutesText = reminder.minutes ? `${reminder.minutes}åˆ†é’Ÿ` : '';
                const statusText = reminder.enabled ? 'å¯ç”¨' : 'æš‚åœ';
                const statusClass = reminder.enabled ? 'status-ongoing' : 'status-finished';
                
                reminderItem.innerHTML = `
                    <div class="item-header">
                        <div class="item-title">${reminder.type} ${minutesText}</div>
                        <div class="controls">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                            <button class="btn btn-small reminder-toggle-btn" onclick="toggleReminder(${index})">
                                <i class="fas fa-${reminder.enabled ? 'pause' : 'play'}"></i>
                            </button>
                            <button class="btn btn-small reminder-edit-btn" onclick="editReminder(${index})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-small btn-danger reminder-delete-btn" onclick="deleteReminder(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="item-details">
                        é“ƒå£°: ${reminder.sound}
                    </div>
                `;
                
                // æ‹–æ‹½äº‹ä»¶
                reminderItem.addEventListener('dragstart', handleReminderDragStart);
                reminderItem.addEventListener('dragover', handleDragOver);
                reminderItem.addEventListener('drop', handleReminderDrop);
                reminderItem.addEventListener('dragend', handleDragEnd);
                
                reminderList.appendChild(reminderItem);
            });
            
            // æ›´æ–°é”å®šçŠ¶æ€ï¼ˆç¡®ä¿æ–°ç”Ÿæˆçš„æŒ‰é’®ä¹Ÿå—é”å®šæ§åˆ¶ï¼‰
            updateLockState();
        }

        // æ›´æ–°å¾ªç¯è®¾ç½®
        function updateRecurrenceSettings() {
            const recurrenceType = document.getElementById('examRecurrence').value;
            const endGroup = document.getElementById('recurrenceEndGroup');
            
            if (recurrenceType === 'once') {
                endGroup.style.display = 'none';
            } else {
                endGroup.style.display = 'block';
            }
        }

        // è·å–å¾ªç¯æ–‡æœ¬æè¿°
        function getRecurrenceText(recurrence, endDate) {
            switch (recurrence) {
                case 'once':
                    return 'ä¸€æ¬¡';
                case 'daily':
                    if (endDate) {
                        return `æ¯å¤©(è‡³${endDate})`;
                    } else {
                        return 'æ¯å¤©';
                    }
                case 'weekly':
                    if (endDate) {
                        return `æ¯å‘¨(è‡³${endDate})`;
                    } else {
                        return 'æ¯å‘¨';
                    }
                case 'monthly':
                    if (endDate) {
                        return `æ¯æœˆ(è‡³${endDate})`;
                    } else {
                        return 'æ¯æœˆ';
                    }
                default:
                    return 'ä¸€æ¬¡';
            }
        }

        // æ ¹æ®å¾ªç¯è®¾ç½®ç”Ÿæˆè€ƒè¯•å®ä¾‹
        function generateExamInstances(exam) {
            const instances = [];
            const startDate = new Date(exam.date);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (exam.recurrence === 'once') {
                instances.push({
                    ...exam,
                    originalIndex: exam.originalIndex || 0
                });
            } else {
                const endDate = exam.recurrenceEndDate ? new Date(exam.recurrenceEndDate) : null;
                let currentDate = new Date(startDate);
                let instanceIndex = 0;
                
                // æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äºç­‰äºä»Šå¤©çš„æ—¥æœŸ
                while (currentDate < today && (!endDate || currentDate <= endDate)) {
                    if (exam.recurrence === 'daily') {
                        currentDate.setDate(currentDate.getDate() + 1);
                    } else if (exam.recurrence === 'weekly') {
                        currentDate.setDate(currentDate.getDate() + 7);
                    } else if (exam.recurrence === 'monthly') {
                        currentDate.setMonth(currentDate.getMonth() + 1);
                    }
                    instanceIndex++;
                    
                    // é˜²æ­¢æ— é™å¾ªç¯
                    if (instanceIndex > 1000) break;
                }
                
                // åªæ·»åŠ æ‰¾åˆ°çš„æœ€è¿‘ä¸€æ¬¡è€ƒè¯•
                if (currentDate >= today && (!endDate || currentDate <= endDate)) {
                    instances.push({
                        ...exam,
                        date: currentDate.toISOString().split('T')[0],
                        originalIndex: exam.originalIndex || 0,
                        instanceIndex: instanceIndex
                    });
                }
            }
            
            return instances;
        }

        // è·å–æ‰€æœ‰è€ƒè¯•å®ä¾‹ï¼ˆåŒ…å«å¾ªç¯ç”Ÿæˆçš„ï¼‰
        function getAllExamInstances() {
            let allInstances = [];
            
            config.exams.forEach((exam, index) => {
                const examWithIndex = { ...exam, originalIndex: index };
                const instances = generateExamInstances(examWithIndex);
                allInstances = allInstances.concat(instances);
            });
            
            // æŒ‰æ—¥æœŸå’Œæ—¶é—´æ’åº
            allInstances.sort((a, b) => {
                const dateTimeA = new Date(`${a.date} ${a.startTime}`);
                const dateTimeB = new Date(`${b.date} ${b.startTime}`);
                return dateTimeA - dateTimeB;
            });
            
            return allInstances;
        }
        function getExamStatus(exam) {
            const now = new Date();
            const examStart = new Date(`${exam.date} ${exam.startTime}`);
            const examEnd = new Date(examStart.getTime() + exam.duration * 60000);
            
            if (now < examStart) {
                return { text: 'æœªå¼€å§‹', class: 'upcoming' };
            } else if (now >= examStart && now <= examEnd) {
                return { text: 'è¿›è¡Œä¸­', class: 'ongoing' };
            } else {
                return { text: 'å·²ç»“æŸ', class: 'finished' };
            }
        }

        // è®¡ç®—ç»“æŸæ—¶é—´
        function calculateEndTime(startTime, duration) {
            const [hours, minutes] = startTime.split(':').map(Number);
            const startMinutes = hours * 60 + minutes;
            const endMinutes = startMinutes + duration;
            const endHours = Math.floor(endMinutes / 60) % 24;
            const endMins = endMinutes % 60;
            return `${endHours.toString().padStart(2, '0')}:${endMins.toString().padStart(2, '0')}`;
        }

        // å¼€å§‹æ—¶é—´æ›´æ–°
        function startTimeUpdate() {
            updateTime();
            setInterval(updateTime, 1000);
        }

        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTime() {
            const now = new Date();
            
            // å½“å‰æ—¶é—´ - åˆ†ç¦»æ—¶é—´å’Œæ—¥æœŸ
            const timeOnly = now.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            const dateOnly = now.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                weekday: 'long'
            });
            document.getElementById('currentTime').innerHTML = `<div style="font-size: 2.2em; font-weight: bold; background: linear-gradient(45deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 5px;">${timeOnly}</div><div style="font-size: 0.8em; color: #666;">${dateOnly}</div>`;
            
            // è€ƒè¯•å€’è®¡æ—¶æˆ–è¿›åº¦
            updateCountdown(now);
            
            // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡è€ƒè¯•åˆ—è¡¨çŠ¶æ€ï¼ˆåœ¨ç§’æ•°ä¸º0æ—¶ï¼‰
            if (now.getSeconds() === 0) {
                updateExamList();
            }
            
            // å¦‚æœåœ¨å…¨å±æ¨¡å¼ä¸‹ï¼Œæ›´æ–°è€ƒè¯•ä¿¡æ¯
            if (document.body.classList.contains('fullscreen-mode')) {
                updateFullscreenExamInfo();
            }
        }

        // æ›´æ–°å€’è®¡æ—¶
        function updateCountdown(now) {
            const nextExam = getNextExam(now);
            const currentExam = getCurrentExam(now);
            
            if (currentExam) {
                // æ˜¾ç¤ºè€ƒè¯•è¿›åº¦
                document.getElementById('countdownLabel').textContent = '';
                const examStart = new Date(`${currentExam.date} ${currentExam.startTime}`);
                const examEnd = new Date(examStart.getTime() + currentExam.duration * 60000);
                
                const elapsedSeconds = Math.floor((now - examStart) / 1000);
                const remainingSeconds = Math.floor((examEnd - now) / 1000);
                
                // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤ºï¼ˆ--åˆ†--ç§’ï¼‰
                const formatTime = (totalSeconds) => {
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    const seconds = totalSeconds % 60;
                    
                    if (hours > 0) {
                        const totalMinutes = hours * 60 + minutes;
                        return `${totalMinutes}åˆ†${seconds.toString().padStart(2, '0')}ç§’`;
                    } else {
                        return `${minutes}åˆ†${seconds.toString().padStart(2, '0')}ç§’`;
                    }
                };
                
                // è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
                const totalSeconds = currentExam.duration * 60;
                const progressPercent = Math.min((elapsedSeconds / totalSeconds) * 100, 100);
                
                // æ ¹æ®è¿›åº¦ç™¾åˆ†æ¯”è®¡ç®—é¢œè‰²ï¼ˆè¿”å›çº¯è‰²ç”¨äºlinear-gradientï¼‰
                const getProgressColor = (percent) => {
                    if (percent <= 30) {
                        // 0-30%: ç»¿è‰²
                        return '#37b24d';
                    } else if (percent <= 60) {
                        // 30-60%: è“è‰²
                        return '#339af0';
                    } else if (percent <= 80) {
                        // 60-80%: æ©™è‰²
                        return '#f76707';
                    } else {
                        // 80-100%: çº¢è‰²
                        return '#e03131';
                    }
                };
                
                // æ ¹æ®è¿›åº¦ç™¾åˆ†æ¯”è®¡ç®—æ¸å˜èƒŒæ™¯
                const getProgressGradient = (percent) => {
                    if (percent <= 30) {
                        return `linear-gradient(45deg, #2d8f47, #37b24d)`;
                    } else if (percent <= 60) {
                        return `linear-gradient(45deg, #1971c2, #339af0)`;
                    } else if (percent <= 80) {
                        return `linear-gradient(45deg, #d9480f, #f76707)`;
                    } else {
                        return `linear-gradient(45deg, #c92a2a, #e03131)`;
                    }
                };
                
                // æ ¹æ®è¿›åº¦ç™¾åˆ†æ¯”è®¡ç®—æ–‡å­—é¢œè‰²ï¼ˆçº¯è‰²ï¼‰
                const getTextColor = (percent) => {
                    if (percent <= 30) {
                        return '#2d8f47'; // æ·±ç»¿è‰²
                    } else if (percent <= 60) {
                        return '#1971c2'; // æ·±è“è‰²
                    } else if (percent <= 80) {
                        return '#d9480f'; // æ·±æ©™è‰²
                    } else {
                        return '#c92a2a'; // æ·±çº¢è‰²
                    }
                };
                
                // è°ƒè¯•ä¿¡æ¯
                console.log('Progress:', progressPercent, 'Color:', getProgressColor(progressPercent));
                
                document.getElementById('countdown').innerHTML = 
                    `${currentExam.subject}<br>
                    <div style="display: flex; justify-content: center; gap: 20px; margin-top: 5px; font-size: 0.6em;">
                        <span style="color: ${getTextColor(progressPercent)}; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); font-weight: bold;">å·²è¿›è¡Œ: ${formatTime(elapsedSeconds)}</span>
                        <span style="color: ${getTextColor(progressPercent)}; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); font-weight: bold;">å‰©ä½™: ${formatTime(remainingSeconds)}</span>
                    </div>
                    <div class="progress-single" style="height: 20px; width: 100%; background: ${getProgressGradient(progressPercent)}; background-size: ${progressPercent}% 100%; background-repeat: no-repeat; background-color: rgba(255,255,255,0.2); border-radius: 10px; border: 1px solid rgba(255,255,255,0.3);"></div>`;
            } else if (nextExam) {
                // æ˜¾ç¤ºå€’è®¡æ—¶
                document.getElementById('countdownLabel').textContent = '';
                const examStart = new Date(`${nextExam.date} ${nextExam.startTime}`);
                const timeDiff = examStart - now;
                
                const days = Math.floor(timeDiff / (24 * 60 * 60 * 1000));
                const hours = Math.floor((timeDiff % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
                const minutes = Math.floor((timeDiff % (60 * 60 * 1000)) / (60 * 1000));
                const seconds = Math.floor((timeDiff % (60 * 1000)) / 1000);
                
                let timeDisplay;
                if (days > 0) {
                    timeDisplay = `${days}å¤©${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                } else {
                    timeDisplay = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                
                document.getElementById('countdown').innerHTML = 
                    `è·ç¦»${nextExam.subject}ç§‘å¼€å§‹è€ƒè¯•è¿˜æœ‰<br>${timeDisplay}`;
            } else {
                document.getElementById('countdownLabel').textContent = '';
                document.getElementById('countdown').textContent = 'æš‚æ— è€ƒè¯•å®‰æ’';
            }
        }

        // è·å–ä¸‹ä¸€åœºè€ƒè¯•
        function getNextExam(now) {
            const allInstances = getAllExamInstances();
            return allInstances
                .filter(exam => new Date(`${exam.date} ${exam.startTime}`) > now)[0]; // å·²æŒ‰æ—¥æœŸæ’åº
        }

        // è·å–å½“å‰è€ƒè¯•
        function getCurrentExam(now) {
            const allInstances = getAllExamInstances();
            return allInstances.find(exam => {
                const examStart = new Date(`${exam.date} ${exam.startTime}`);
                const examEnd = new Date(examStart.getTime() + exam.duration * 60000);
                return now >= examStart && now <= examEnd;
            });
        }

        // å¼€å§‹æé†’æ£€æŸ¥
        function startReminderCheck() {
            reminderCheckInterval = setInterval(checkReminders, 1000);
        }

        // ä¸ºå¾ªç¯è€ƒè¯•ç”Ÿæˆæœªæ¥çš„æé†’å®ä¾‹
        function generateUpcomingReminders(exam) {
            if (exam.recurrence === 'once') {
                return [exam];
            }
            
            const reminders = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // ä»å½“å‰æ˜¾ç¤ºçš„è€ƒè¯•å®ä¾‹å¼€å§‹ï¼Œç”Ÿæˆæœªæ¥3æ¬¡è€ƒè¯•çš„æé†’
            let currentDate = new Date(exam.date);
            let instanceIndex = exam.instanceIndex || 0;
            const endDate = exam.recurrenceEndDate ? new Date(exam.recurrenceEndDate) : null;
            
            for (let i = 0; i < 3; i++) {
                if (endDate && currentDate > endDate) break;
                
                reminders.push({
                    ...exam,
                    date: currentDate.toISOString().split('T')[0],
                    instanceIndex: instanceIndex
                });
                
                // è®¡ç®—ä¸‹ä¸€æ¬¡è€ƒè¯•æ—¥æœŸ
                if (exam.recurrence === 'daily') {
                    currentDate.setDate(currentDate.getDate() + 1);
                } else if (exam.recurrence === 'weekly') {
                    currentDate.setDate(currentDate.getDate() + 7);
                } else if (exam.recurrence === 'monthly') {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                }
                instanceIndex++;
            }
            
            return reminders;
        }
        // è·å–ä¸Šä¸€ç§‘è€ƒè¯•
        function getPreviousExam(currentExam, allExamInstances) {
            // æŒ‰æ—¶é—´æ’åºæ‰€æœ‰è€ƒè¯•å®ä¾‹
            const sortedExams = allExamInstances.slice().sort((a, b) => {
                const dateTimeA = new Date(`${a.date} ${a.startTime}`);
                const dateTimeB = new Date(`${b.date} ${b.startTime}`);
                return dateTimeA - dateTimeB;
            });
            
            const currentExamDateTime = new Date(`${currentExam.date} ${currentExam.startTime}`);
            
            // æ‰¾åˆ°å½“å‰è€ƒè¯•çš„ä½ç½®ï¼Œè¿”å›å‰ä¸€ä¸ªè€ƒè¯•
            for (let i = 0; i < sortedExams.length; i++) {
                const examDateTime = new Date(`${sortedExams[i].date} ${sortedExams[i].startTime}`);
                if (examDateTime.getTime() === currentExamDateTime.getTime() && 
                    sortedExams[i].subject === currentExam.subject) {
                    // æ‰¾åˆ°å½“å‰è€ƒè¯•ï¼Œè¿”å›å‰ä¸€ä¸ªè€ƒè¯•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    return i > 0 ? sortedExams[i - 1] : null;
                }
            }
            
            return null;
        }

        // æ£€æŸ¥æé†’
        function checkReminders() {
            const now = new Date();
            
            // æ¸…ç†è¿‡æœŸçš„å·²æ’­æ”¾æé†’è®°å½•
            cleanupPlayedReminders(now);
            
            // å¤„ç†å»¶è¿Ÿæ’­æ”¾çš„æé†’
            processDelayedReminders(now);
            
            // è·å–æ‰€æœ‰è€ƒè¯•å®ä¾‹ï¼ˆä½†ä¸ºå¾ªç¯è€ƒè¯•ç”Ÿæˆæœªæ¥çš„æé†’ï¼‰
            const allExamInstances = getAllExamInstances();
            
            allExamInstances.forEach(exam => {
                // ä¸ºå¾ªç¯è€ƒè¯•ç”Ÿæˆæœªæ¥çš„æé†’å®ä¾‹
                const reminderInstances = generateUpcomingReminders(exam);
                
                reminderInstances.forEach(reminderExam => {
                    config.reminders.forEach(reminder => {
                        if (!reminder.enabled) return;
                        
                        const examStart = new Date(`${reminderExam.date} ${reminderExam.startTime}`);
                        const examEnd = new Date(examStart.getTime() + reminderExam.duration * 60000);
                        
                        // ä¸ºå¾ªç¯è€ƒè¯•åˆ›å»ºå”¯ä¸€çš„æé†’é”®å€¼
                        let reminderKey = `${reminderExam.subject}-${reminderExam.date}-${reminder.type}-${reminder.minutes || 0}`;
                        if (reminderExam.instanceIndex !== undefined) {
                            reminderKey += `-${reminderExam.instanceIndex}`;
                        }
                        
                        if (playedReminders.has(reminderKey)) return;
                        
                        let shouldPlay = false;
                        let isEndReminder = false;
                        
                        switch (reminder.type) {
                            case 'å¼€è€ƒå‰':
                                const beforeTime = new Date(examStart.getTime() - (reminder.minutes || 0) * 60000);
                                const timeDiff = now - beforeTime;
                                shouldPlay = timeDiff >= 0 && timeDiff <= 5000 && now < examStart;
                                
                                // æ£€æŸ¥æ˜¯å¦åº”è¯¥ç¦æ­¢æ’­æŠ¥ï¼šåœ¨ä¸Šä¸€ç§‘è€ƒè¯•ç»“æŸå‰ç¦æ­¢æ’­æŠ¥ä¸‹ä¸€ç§‘çš„ä»»ä½•å¼€è€ƒå‰æé†’
                                if (shouldPlay) {
                                    const previousExam = getPreviousExam(reminderExam, allExamInstances);
                                    if (previousExam) {
                                        const prevExamEnd = new Date(`${previousExam.date} ${previousExam.startTime}`);
                                        prevExamEnd.setMinutes(prevExamEnd.getMinutes() + previousExam.duration);
                                        
                                        // å¦‚æœä¸Šä¸€ç§‘è€ƒè¯•è¿˜æœªç»“æŸï¼Œåˆ™ç¦æ­¢æ’­æŠ¥ä¸‹ä¸€ç§‘çš„ä»»ä½•å¼€è€ƒå‰æé†’
                                        if (now < prevExamEnd) {
                                            shouldPlay = false;
                                            console.log(`é˜»æ­¢å¼€è€ƒå‰æé†’ï¼šä¸Šä¸€ç§‘${previousExam.subject}è¿˜æœªç»“æŸ`);
                                        }
                                    }
                                }
                                break;
                            case 'ç»“æŸå‰':
                                const beforeEndTime = new Date(examEnd.getTime() - (reminder.minutes || 0) * 60000);
                                const endTimeDiff = now - beforeEndTime;
                                shouldPlay = endTimeDiff >= 0 && endTimeDiff <= 5000 && now < examEnd;
                                break;
                            case 'å¼€å§‹è€ƒè¯•':
                                shouldPlay = now >= examStart && (now - examStart) <= 2000;
                                break;
                            case 'è€ƒè¯•ç»“æŸ':
                                shouldPlay = now >= examEnd && (now - examEnd) <= 2000;
                                isEndReminder = true;
                                break;
                        }
                        
                        if (shouldPlay) {
                            // æ£€æŸ¥è¯­éŸ³å†²çª
                            const conflictingReminder = checkAudioConflict(reminder, reminderExam, now, allExamInstances);
                            
                            if (conflictingReminder) {
                                // å¤„ç†å†²çªï¼šå¦‚æœå½“å‰æ˜¯è€ƒè¯•ç»“æŸæé†’ä¸å¼€è€ƒå‰æé†’å†²çª
                                if (isEndReminder && conflictingReminder.type === 'å¼€è€ƒå‰') {
                                    // å…ˆæ’­æ”¾è€ƒè¯•ç»“æŸæé†’
                                    addToAudioQueue(reminder, reminderExam, reminderKey);
                                    
                                    // 30ç§’åæ’­æ”¾å¼€è€ƒå‰æé†’
                                    const delayedTime = new Date(now.getTime() + 30000);
                                    pendingDelayedReminders.push({
                                        reminder: conflictingReminder.reminder,
                                        exam: conflictingReminder.exam,
                                        key: conflictingReminder.key,
                                        scheduledTime: delayedTime
                                    });
                                    
                                    console.log(`å†²çªå¤„ç†ï¼šå…ˆæ’­æ”¾${reminder.type}ï¼Œ30ç§’åæ’­æ”¾${conflictingReminder.type}`);
                                } else {
                                    // å…¶ä»–å†²çªæƒ…å†µï¼Œç›´æ¥åŠ å…¥é˜Ÿåˆ—
                                    addToAudioQueue(reminder, reminderExam, reminderKey);
                                }
                            } else {
                                addToAudioQueue(reminder, reminderExam, reminderKey);
                            }
                            
                            playedReminders.add(reminderKey);
                        }
                    });
                });
            });
            
            // å¤„ç†éŸ³é¢‘é˜Ÿåˆ—
            processAudioQueue();
        }

        // æ¸…ç†è¿‡æœŸçš„å·²æ’­æ”¾æé†’è®°å½•
        function cleanupPlayedReminders(now) {
            const keysToRemove = [];
            
            playedReminders.forEach(key => {
                // è§£ææé†’é”®å€¼ï¼šç§‘ç›®-æ—¥æœŸ-ç±»å‹-åˆ†é’Ÿæ•°
                const parts = key.split('-');
                if (parts.length >= 3) {
                    const examDate = parts[1];
                    const examTime = config.exams.find(exam => 
                        exam.subject === parts[0] && exam.date === examDate
                    );
                    
                    if (examTime) {
                        const examStart = new Date(`${examTime.date} ${examTime.startTime}`);
                        const examEnd = new Date(examStart.getTime() + examTime.duration * 60000);
                        
                        // å¦‚æœè€ƒè¯•å·²ç»“æŸè¶…è¿‡1å°æ—¶ï¼Œæ¸…ç†ç›¸å…³æé†’è®°å½•
                        if (now - examEnd > 60 * 60 * 1000) {
                            keysToRemove.push(key);
                        }
                    }
                }
            });
            
            keysToRemove.forEach(key => playedReminders.delete(key));
        }

        // æ£€æŸ¥éŸ³é¢‘å†²çª
        function checkAudioConflict(currentReminder, currentExam, now, allExamInstances) {
            const currentTime = now.getTime();
            const conflictBufferTime = 10000; // 10ç§’ç¼“å†²æ—¶é—´
            
            // æ£€æŸ¥æ˜¯å¦æ­£åœ¨æ’­æ”¾éŸ³é¢‘
            if (isPlayingAudio) {
                return { 
                    type: 'playing',
                    reminder: currentReminder,
                    exam: currentExam,
                    key: `${currentExam.subject}-${currentExam.date}-${currentReminder.type}-${currentReminder.minutes || 0}`
                };
            }
            
            // æ£€æŸ¥åŒæ—¶é—´æ®µå†…çš„å…¶ä»–æé†’ï¼ˆç‰¹åˆ«æ˜¯è€ƒè¯•ç»“æŸä¸å¼€è€ƒå‰æé†’ï¼‰
            for (const exam of allExamInstances) {
                const reminderInstances = generateUpcomingReminders(exam);
                
                for (const reminderExam of reminderInstances) {
                    if (reminderExam.subject === currentExam.subject && 
                        reminderExam.date === currentExam.date &&
                        reminderExam.startTime === currentExam.startTime) {
                        continue; // è·³è¿‡åŒä¸€è€ƒè¯•
                    }
                    
                    for (const reminder of config.reminders) {
                        if (!reminder.enabled || reminder === currentReminder) continue;
                        
                        const examStart = new Date(`${reminderExam.date} ${reminderExam.startTime}`);
                        const examEnd = new Date(examStart.getTime() + reminderExam.duration * 60000);
                        
                        let reminderTime;
                        
                        switch (reminder.type) {
                            case 'å¼€è€ƒå‰':
                                reminderTime = new Date(examStart.getTime() - (reminder.minutes || 0) * 60000);
                                break;
                            case 'ç»“æŸå‰':
                                reminderTime = new Date(examEnd.getTime() - (reminder.minutes || 0) * 60000);
                                break;
                            case 'å¼€å§‹è€ƒè¯•':
                                reminderTime = examStart;
                                break;
                            case 'è€ƒè¯•ç»“æŸ':
                                reminderTime = examEnd;
                                break;
                            default:
                                continue;
                        }
                        
                        // æ£€æŸ¥æ—¶é—´æ˜¯å¦åœ¨å†²çªç¼“å†²èŒƒå›´å†…
                        const timeDiff = Math.abs(currentTime - reminderTime.getTime());
                        
                        if (timeDiff <= conflictBufferTime) {
                            return {
                                type: reminder.type,
                                reminder: reminder,
                                exam: reminderExam,
                                key: `${reminderExam.subject}-${reminderExam.date}-${reminder.type}-${reminder.minutes || 0}`,
                                timeDiff: timeDiff
                            };
                        }
                    }
                }
            }
            
            return null;
        }
        
        // æ·»åŠ åˆ°éŸ³é¢‘é˜Ÿåˆ—
        function addToAudioQueue(reminder, exam, key) {
            audioQueue.push({
                reminder: reminder,
                exam: exam,
                key: key,
                timestamp: Date.now()
            });
            
            console.log(`æ·»åŠ åˆ°éŸ³é¢‘é˜Ÿåˆ—: ${exam.subject} - ${reminder.type}`);
        }
        
        // å¤„ç†éŸ³é¢‘é˜Ÿåˆ—
        function processAudioQueue() {
            if (isPlayingAudio || audioQueue.length === 0) {
                return;
            }
            
            const queueItem = audioQueue.shift();
            isPlayingAudio = true;
            
            console.log(`å¼€å§‹æ’­æ”¾: ${queueItem.exam.subject} - ${queueItem.reminder.type}`);
            
            const audio = new Audio();
            
            if (customSounds[queueItem.reminder.sound]) {
                audio.src = customSounds[queueItem.reminder.sound];
            } else {
                audio.src = `./sounds/${queueItem.reminder.sound}`;
            }
            
            audio.onended = () => {
                isPlayingAudio = false;
                console.log(`æ’­æ”¾ç»“æŸ: ${queueItem.exam.subject} - ${queueItem.reminder.type}`);
                
                // å¦‚æœæ˜¯è€ƒè¯•ç»“æŸæé†’ï¼Œæ£€æŸ¥æ˜¯å¦æœ¬åœºå…¨éƒ¨è€ƒè¯•å·²ç»“æŸ
                if (queueItem.reminder.type === 'è€ƒè¯•ç»“æŸ') {
                    checkAllExamsEndedForToday(queueItem.exam);
                }
                
                // ç»§ç»­å¤„ç†é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªéŸ³é¢‘
                setTimeout(() => {
                    processAudioQueue();
                }, 500); // 0.5ç§’é—´éš”
            };
            
            audio.onerror = () => {
                isPlayingAudio = false;
                console.error(`æ’­æ”¾å¤±è´¥: ${queueItem.reminder.sound}`);
                showNotification(`æ’­æ”¾æé†’å¤±è´¥: ${queueItem.reminder.sound}`, 'error');
                
                // ç»§ç»­å¤„ç†é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªéŸ³é¢‘
                setTimeout(() => {
                    processAudioQueue();
                }, 500);
            };
            
            audio.play().catch(error => {
                isPlayingAudio = false;
                console.error('æ’­æ”¾éŸ³é¢‘å¤±è´¥:', error);
                showNotification(`æ’­æ”¾æé†’å¤±è´¥: ${queueItem.reminder.sound}`, 'error');
                
                // ç»§ç»­å¤„ç†é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªéŸ³é¢‘
                setTimeout(() => {
                    processAudioQueue();
                }, 500);
            });
            
            const message = `${queueItem.exam.subject} - ${queueItem.reminder.type}${queueItem.reminder.minutes ? `(${queueItem.reminder.minutes}åˆ†é’Ÿ)` : ''}`;
            showNotification(message);
        }
        
        // å¤„ç†å»¶è¿Ÿæ’­æ”¾çš„æé†’
        function processDelayedReminders(now) {
            const readyReminders = [];
            const remainingReminders = [];
            
            pendingDelayedReminders.forEach(delayedItem => {
                if (now >= delayedItem.scheduledTime) {
                    // æ£€æŸ¥æ˜¯å¦å·²ç»æ’­æ”¾è¿‡
                    if (!playedReminders.has(delayedItem.key)) {
                        readyReminders.push(delayedItem);
                        playedReminders.add(delayedItem.key);
                    }
                } else {
                    remainingReminders.push(delayedItem);
                }
            });
            
            // æ›´æ–°å¾…å¤„ç†åˆ—è¡¨
            pendingDelayedReminders = remainingReminders;
            
            // å°†å‡†å¤‡å¥½çš„æé†’åŠ å…¥éŸ³é¢‘é˜Ÿåˆ—
            readyReminders.forEach(item => {
                addToAudioQueue(item.reminder, item.exam, item.key);
                console.log(`å»¶è¿Ÿæé†’å‡†å¤‡æ’­æ”¾: ${item.exam.subject} - ${item.reminder.type}`);
            });
        }

        // æ·»åŠ è€ƒè¯•
        function addExam() {
            currentEditingExam = null;
            document.getElementById('examModalTitle').textContent = 'æ·»åŠ è€ƒè¯•';
            document.getElementById('examForm').reset();
            
            // é‡ç½®å¾ªç¯è®¾ç½®ä¸ºé»˜è®¤å€¼
            document.getElementById('examRecurrence').value = 'once';
            document.getElementById('recurrenceEndDate').value = '';
            updateRecurrenceSettings();
            
            document.getElementById('examModal').style.display = 'block';
        }

        // ç¼–è¾‘è€ƒè¯•
        function editExam(index) {
            currentEditingExam = index;
            const exam = config.exams[index];
            document.getElementById('examModalTitle').textContent = 'ç¼–è¾‘è€ƒè¯•';
            document.getElementById('examSubject').value = exam.subject;
            document.getElementById('examDate').value = exam.date;
            document.getElementById('examStartTime').value = exam.startTime;
            document.getElementById('examDuration').value = exam.duration;
            
            // è®¾ç½®å¾ªç¯é€‰é¡¹
            document.getElementById('examRecurrence').value = exam.recurrence || 'once';
            document.getElementById('recurrenceEndDate').value = exam.recurrenceEndDate || '';
            
            updateRecurrenceSettings();
            updateEndTime();
            document.getElementById('examModal').style.display = 'block';
        }

        // åˆ é™¤è€ƒè¯•
        function deleteExam(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè€ƒè¯•å—ï¼Ÿ')) {
                config.exams.splice(index, 1);
                saveToLocalStorage();
                updateExamList();
                showNotification('è€ƒè¯•å·²åˆ é™¤');
            }
        }

        // å…³é—­è€ƒè¯•æ¨¡æ€æ¡†
        function closeExamModal() {
            document.getElementById('examModal').style.display = 'none';
        }

        // æ›´æ–°ç»“æŸæ—¶é—´
        function updateEndTime() {
            const startTime = document.getElementById('examStartTime').value;
            const duration = parseInt(document.getElementById('examDuration').value) || 0;
            
            if (startTime && duration) {
                const endTime = calculateEndTime(startTime, duration);
                document.getElementById('examEndTime').textContent = endTime;
            } else {
                document.getElementById('examEndTime').textContent = '--:--';
            }
        }

        // è€ƒè¯•è¡¨å•äº‹ä»¶
        document.getElementById('examForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const exam = {
                subject: document.getElementById('examSubject').value,
                date: document.getElementById('examDate').value,
                startTime: document.getElementById('examStartTime').value,
                duration: parseInt(document.getElementById('examDuration').value),
                recurrence: document.getElementById('examRecurrence').value,
                recurrenceEndDate: document.getElementById('recurrenceEndDate').value || null
            };
            
            if (currentEditingExam !== null) {
                // æ¸…ç†ä¸è¯¥è€ƒè¯•ç›¸å…³çš„å·²æ’­æ”¾æé†’è®°å½•
                const oldExam = config.exams[currentEditingExam];
                
                // åˆ é™¤æ‰€æœ‰ä¸æ—§è€ƒè¯•ç›¸å…³çš„å·²æ’­æ”¾æé†’è®°å½•
                const keysToRemove = [];
                playedReminders.forEach(key => {
                    // æ£€æŸ¥é”®å€¼æ˜¯å¦åŒ…å«æ—§è€ƒè¯•çš„ç§‘ç›®å’Œæ—¥æœŸ
                    if (key.startsWith(`${oldExam.subject}-${oldExam.date}-`)) {
                        keysToRemove.push(key);
                    }
                });
                
                // åˆ é™¤åŒ¹é…çš„é”®å€¼
                keysToRemove.forEach(key => playedReminders.delete(key));
                
                config.exams[currentEditingExam] = exam;
                showNotification('è€ƒè¯•å·²æ›´æ–°');
                
                // ç«‹å³æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æ’­æ”¾çš„æé†’
                setTimeout(() => {
                    checkReminders();
                }, 100);
            } else {
                config.exams.push(exam);
                showNotification('è€ƒè¯•å·²æ·»åŠ ');
            }
            
            saveToLocalStorage();
            updateExamList();
            closeExamModal();
        });

        // ç›‘å¬æ—¶é—´å’Œæ—¶é•¿å˜åŒ–
        document.getElementById('examStartTime').addEventListener('input', updateEndTime);
        document.getElementById('examDuration').addEventListener('input', updateEndTime);

        // æ·»åŠ æé†’
        function addReminder() {
            currentEditingReminder = null;
            document.getElementById('reminderModalTitle').textContent = 'æ·»åŠ æé†’';
            document.getElementById('reminderForm').reset();
            document.getElementById('reminderType').value = 'å¼€è€ƒå‰';
            updateReminderForm();
            document.getElementById('reminderModal').style.display = 'block';
        }

        // ç¼–è¾‘æé†’
        function editReminder(index) {
            currentEditingReminder = index;
            const reminder = config.reminders[index];
            document.getElementById('reminderModalTitle').textContent = 'ç¼–è¾‘æé†’';
            document.getElementById('reminderType').value = reminder.type;
            document.getElementById('reminderMinutes').value = reminder.minutes || 15;
            document.getElementById('reminderSound').value = reminder.sound;
            updateReminderForm();
            document.getElementById('reminderModal').style.display = 'block';
        }

        // åˆ é™¤æé†’
        function deleteReminder(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæé†’å—ï¼Ÿ')) {
                config.reminders.splice(index, 1);
                saveToLocalStorage();
                updateReminderList();
                showNotification('æé†’å·²åˆ é™¤');
            }
        }

        // åˆ‡æ¢æé†’çŠ¶æ€
        function toggleReminder(index) {
            config.reminders[index].enabled = !config.reminders[index].enabled;
            saveToLocalStorage();
            updateReminderList();
            const status = config.reminders[index].enabled ? 'å¯ç”¨' : 'æš‚åœ';
            showNotification(`æé†’å·²${status}`);
        }

        // å…³é—­æé†’æ¨¡æ€æ¡†
        function closeReminderModal() {
            document.getElementById('reminderModal').style.display = 'none';
        }

        // æ˜¾ç¤ºå¸®åŠ©
        function showHelp() {
            document.getElementById('helpModal').style.display = 'block';
        }
        



        // å…³é—­å¸®åŠ©æ¨¡æ€æ¡†
        function closeHelpModal() {
            document.getElementById('helpModal').style.display = 'none';
        }

        // æ›´æ–°æé†’è¡¨å•
        function updateReminderForm() {
            const type = document.getElementById('reminderType').value;
            const minutesGroup = document.getElementById('minutesGroup');
            
            if (type === 'å¼€è€ƒå‰' || type === 'ç»“æŸå‰') {
                minutesGroup.style.display = 'block';
            } else {
                minutesGroup.style.display = 'none';
            }
        }

        // æé†’è¡¨å•äº‹ä»¶
        document.getElementById('reminderForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const type = document.getElementById('reminderType').value;
            const reminder = {
                type: type,
                sound: document.getElementById('reminderSound').value,
                enabled: true
            };
            
            if (type === 'å¼€è€ƒå‰' || type === 'ç»“æŸå‰') {
                reminder.minutes = parseInt(document.getElementById('reminderMinutes').value);
            }
            
            if (currentEditingReminder !== null) {
                config.reminders[currentEditingReminder] = reminder;
                showNotification('æé†’å·²æ›´æ–°');
            } else {
                config.reminders.push(reminder);
                showNotification('æé†’å·²æ·»åŠ ');
            }
            
            saveToLocalStorage();
            updateReminderList();
            closeReminderModal();
        });

        // æ’­æ”¾éŸ³é¢‘
        function playSound() {
            const soundFile = document.getElementById('reminderSound').value;
            if (!soundFile) {
                showNotification('è¯·å…ˆé€‰æ‹©é“ƒå£°', 'error');
                return;
            }
            
            // å¦‚æœæ­£åœ¨æ’­æ”¾å…¶ä»–éŸ³é¢‘ï¼Œå…ˆåœæ­¢
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            
            currentAudio = new Audio();
            
            if (customSounds[soundFile]) {
                currentAudio.src = customSounds[soundFile];
            } else {
                currentAudio.src = `./sounds/${soundFile}`;
            }
            
            currentAudio.play().catch(error => {
                console.error('æ’­æ”¾éŸ³é¢‘å¤±è´¥:', error);
                showNotification('æ’­æ”¾éŸ³é¢‘å¤±è´¥', 'error');
            });
        }

        // å¯¼å…¥éŸ³é¢‘
        function importAudio(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('audio/')) {
                showNotification('è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const fileName = file.name;
                customSounds[fileName] = e.target.result;
                localStorage.setItem('customSounds', JSON.stringify(customSounds));
                
                if (!availableSounds.includes(fileName)) {
                    availableSounds.push(fileName);
                    updateSoundOptions();
                }
                
                document.getElementById('reminderSound').value = fileName;
                showNotification(`éŸ³é¢‘ ${fileName} å¯¼å…¥æˆåŠŸ`);
            };
            reader.readAsDataURL(file);
        }

        // å¯¼å‡ºé…ç½®
        function exportConfig() {
            const dataStr = JSON.stringify(config, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'exam_config.json';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('é…ç½®å·²å¯¼å‡º');
        }

        // å¯¼å…¥é…ç½®
        function importConfig(event) {
            // æ£€æŸ¥é”å®šçŠ¶æ€
            if (isLocked) {
                showNotification('å½“å‰å¤„äºé”å®šçŠ¶æ€ï¼Œæ— æ³•å¯¼å…¥é…ç½®', 'error');
                event.target.value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedConfig = JSON.parse(e.target.result);
                    config = { ...config, ...importedConfig };
                    saveToLocalStorage();
                    updateDisplay();
                    showNotification('é…ç½®å¯¼å…¥æˆåŠŸ');
                } catch (error) {
                    showNotification('é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯', 'error');
                }
            };
            reader.readAsText(file);
        }

        // æ‹–æ‹½åŠŸèƒ½ - è€ƒè¯•
        let draggedExamIndex = null;
        
        function handleDragStart(e) {
            draggedExamIndex = parseInt(e.target.dataset.index);
            e.target.classList.add('dragging');
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.target.closest('.exam-item')?.classList.add('drag-over');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            const targetIndex = parseInt(e.target.closest('.exam-item').dataset.index);
            
            if (draggedExamIndex !== null && draggedExamIndex !== targetIndex) {
                const draggedExam = config.exams[draggedExamIndex];
                config.exams.splice(draggedExamIndex, 1);
                config.exams.splice(targetIndex, 0, draggedExam);
                saveToLocalStorage();
                updateExamList();
                showNotification('è€ƒè¯•é¡ºåºå·²è°ƒæ•´');
            }
            
            document.querySelectorAll('.exam-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }
        
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.exam-item, .reminder-item').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedExamIndex = null;
            draggedReminderIndex = null;
        }

        // æ‹–æ‹½åŠŸèƒ½ - æé†’
        let draggedReminderIndex = null;
        
        function handleReminderDragStart(e) {
            draggedReminderIndex = parseInt(e.target.dataset.index);
            e.target.classList.add('dragging');
        }
        
        function handleReminderDrop(e) {
            e.preventDefault();
            const targetIndex = parseInt(e.target.closest('.reminder-item').dataset.index);
            
            if (draggedReminderIndex !== null && draggedReminderIndex !== targetIndex) {
                const draggedReminder = config.reminders[draggedReminderIndex];
                config.reminders.splice(draggedReminderIndex, 1);
                config.reminders.splice(targetIndex, 0, draggedReminder);
                saveToLocalStorage();
                updateReminderList();
                showNotification('æé†’é¡ºåºå·²è°ƒæ•´');
            }
            
            document.querySelectorAll('.reminder-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const examModal = document.getElementById('examModal');
            const reminderModal = document.getElementById('reminderModal');
            const helpModal = document.getElementById('helpModal');
            
            if (event.target === examModal) {
                closeExamModal();
            }
            if (event.target === reminderModal) {
                closeReminderModal();
            }
            if (event.target === helpModal) {
                closeHelpModal();
            }
        }

        // ç¼©æ”¾åŠŸèƒ½
        let currentZoom = 100;
        const zoomLevels = [75, 90, 100, 110, 125, 150];

        function zoomIn() {
            const currentIndex = zoomLevels.indexOf(currentZoom);
            if (currentIndex < zoomLevels.length - 1) {
                currentZoom = zoomLevels[currentIndex + 1];
                applyZoom();
            }
        }

        function zoomOut() {
            const currentIndex = zoomLevels.indexOf(currentZoom);
            if (currentIndex > 0) {
                currentZoom = zoomLevels[currentIndex - 1];
                applyZoom();
            }
        }

        function resetZoom() {
            currentZoom = 100;
            applyZoom();
        }

        function applyZoom() {
            const container = document.querySelector('.container');
            container.className = container.className.replace(/zoom-\d+/g, '');
            
            if (currentZoom !== 100) {
                container.classList.add(`zoom-${currentZoom}`);
            }
            
            localStorage.setItem('zoomLevel', currentZoom);
            showNotification(`ç¼©æ”¾: ${currentZoom}%`);
        }

        // å¤œé—´æ¨¡å¼åŠŸèƒ½
        function toggleDarkMode() {
            const body = document.body;
            const darkModeBtn = document.getElementById('darkModeBtn');
            
            body.classList.toggle('dark-mode');
            
            if (body.classList.contains('dark-mode')) {
                darkModeBtn.innerHTML = '<i class="fas fa-sun"></i>';
                darkModeBtn.classList.add('active');
                localStorage.setItem('darkMode', 'true');
                showNotification('å¤œé—´æ¨¡å¼å·²å¼€å¯');
            } else {
                darkModeBtn.innerHTML = '<i class="fas fa-moon"></i>';
                darkModeBtn.classList.remove('active');
                localStorage.setItem('darkMode', 'false');
                showNotification('å¤œé—´æ¨¡å¼å·²å…³é—­');
            }
        }

        // å…¨å±æ¨¡å¼åŠŸèƒ½
        function toggleFullscreen() {
            const body = document.body;
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const timeDisplay = document.querySelector('.time-display');
            const mainContent = document.getElementById('mainContent');
            
            body.classList.toggle('fullscreen-mode');
            
            if (body.classList.contains('fullscreen-mode')) {
                fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                fullscreenBtn.classList.add('active');
                
                // å¦‚æœå½“å‰åœ¨åº§ä½å®‰æ’é¡µé¢ï¼Œæ·»åŠ activeç±»ä»¥åœ¨å…¨å±æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼Œå¹¶éšè—æ—¶é—´æ˜¾ç¤º
                if (currentPage === 'seating') {
                    document.getElementById('seatingContent').classList.add('active');
                    timeDisplay.classList.add('hidden');
                } else if (currentPage === 'main') {
                    // å¦‚æœå½“å‰åœ¨è€ƒè¯•æ’­æŠ¥é¡µé¢ï¼Œç¡®ä¿main-contentéšè—
                    mainContent.style.display = 'none';
                }
                
                // æ›´æ–°å…¨å±æ¨¡å¼ä¸‹çš„è€ƒè¯•ä¿¡æ¯
                updateFullscreenExamInfo();
                
                // è¯·æ±‚æµè§ˆå™¨å…¨å±
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                } else if (document.documentElement.msRequestFullscreen) {
                    document.documentElement.msRequestFullscreen();
                }
                
                showNotification('å…¨å±æ¨¡å¼å·²å¼€å¯');
            } else {
                fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                fullscreenBtn.classList.remove('active');
                
                // é€€å‡ºå…¨å±æ¨¡å¼æ—¶ç§»é™¤activeç±»å’Œhiddenç±»
                document.getElementById('seatingContent').classList.remove('active');
                timeDisplay.classList.remove('hidden');
                
                // é€€å‡ºå…¨å±æ¨¡å¼æ—¶ï¼Œæ ¹æ®å½“å‰é¡µé¢çŠ¶æ€æ¢å¤main-contentæ˜¾ç¤º
                if (currentPage === 'main') {
                    mainContent.style.removeProperty('display');
                }
                
                // é€€å‡ºæµè§ˆå™¨å…¨å±
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                
                showNotification('å…¨å±æ¨¡å¼å·²å…³é—­');
            }
        }

        // æ›´æ–°å…¨å±æ¨¡å¼ä¸‹çš„è€ƒè¯•ä¿¡æ¯
        function updateFullscreenExamInfo() {
            const examListContent = document.getElementById('fullscreenExamListContent');
            
            const allInstances = getAllExamInstances();
            
            if (allInstances.length === 0) {
                examListContent.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">æš‚æ— è€ƒè¯•å®‰æ’</div>';
                return;
            }
            
            examListContent.innerHTML = '';
            
            // åªæ˜¾ç¤ºå‰10ä¸ªè€ƒè¯•å®ä¾‹é¿å…å…¨å±æ¨¡å¼ä¸‹å†…å®¹è¿‡å¤š
            const displayInstances = allInstances.slice(0, 10);
            
            displayInstances.forEach((exam, index) => {
                const examItem = document.createElement('div');
                examItem.className = 'exam-item';
                
                const status = getExamStatus(exam);
                const endTime = calculateEndTime(exam.startTime, exam.duration);
                
                examItem.innerHTML = `
                    <div class="item-header">
                        <div class="item-title">${exam.subject}</div>
                        <div class="controls">
                            <span class="status-badge status-${status.class}">${status.text}</span>
                        </div>
                    </div>
                    <div class="item-details">
                        æ—¥æœŸ: ${exam.date} | æ—¶é—´: ${exam.startTime} - ${endTime} | æ—¶é•¿: ${exam.duration}åˆ†é’Ÿ | å¾ªç¯ï¼š${getRecurrenceText(exam.recurrence, exam.recurrenceEndDate)}
                    </div>
                `;
                
                examListContent.appendChild(examItem);
            });
        }

        // ç›‘å¬æµè§ˆå™¨å…¨å±çŠ¶æ€å˜åŒ–
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('msfullscreenchange', handleFullscreenChange);

        function handleFullscreenChange() {
            const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
            const body = document.body;
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            
            if (!isFullscreen && body.classList.contains('fullscreen-mode')) {
                body.classList.remove('fullscreen-mode');
                fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                fullscreenBtn.classList.remove('active');
                
                // ä¿®å¤é€€å‡ºå…¨å±åçš„ç•Œé¢çŠ¶æ€
                const mainContent = document.getElementById('mainContent');
                const timeDisplay = document.querySelector('.time-display');
                const seatingContent = document.getElementById('seatingContent');
                
                if (currentPage === 'main') {
                    // å¦‚æœå½“å‰æ˜¯è€ƒè¯•ç®¡ç†é¡µé¢ï¼Œç¡®ä¿æ­£ç¡®æ˜¾ç¤º
                    mainContent.style.removeProperty('display');
                    timeDisplay.classList.remove('hidden');
                } else if (currentPage === 'seating') {
                    // å¦‚æœå½“å‰æ˜¯åº§ä½å®‰æ’é¡µé¢ï¼Œä¿æŒåº§ä½å®‰æ’æ˜¾ç¤º
                    seatingContent.classList.remove('active');
                    timeDisplay.classList.remove('hidden');
                }
            }
        }

        // åŠ è½½ä¿å­˜çš„è®¾ç½®
        function loadSettings() {
            // åŠ è½½ç¼©æ”¾è®¾ç½®
            const savedZoom = localStorage.getItem('zoomLevel');
            if (savedZoom) {
                currentZoom = parseInt(savedZoom);
                applyZoom();
            }
            
            // åŠ è½½å¤œé—´æ¨¡å¼è®¾ç½®
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode === 'true') {
                document.body.classList.add('dark-mode');
                const darkModeBtn = document.getElementById('darkModeBtn');
                darkModeBtn.innerHTML = '<i class="fas fa-sun"></i>';
                darkModeBtn.classList.add('active');
            }
        }

        // åœ¨ç°æœ‰çš„DOMContentLoadedäº‹ä»¶ä¸­è°ƒç”¨loadSettings
        // æ³¨æ„ï¼šloadSettings()åº”è¯¥åœ¨ç°æœ‰çš„åˆå§‹åŒ–å‡½æ•°ä¸­è°ƒç”¨

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Plus: æ”¾å¤§
            if ((e.ctrlKey || e.metaKey) && (e.key === '+' || e.key === '=')) {
                e.preventDefault();
                zoomIn();
            }
            // Ctrl/Cmd + Minus: ç¼©å°
            else if ((e.ctrlKey || e.metaKey) && e.key === '-') {
                e.preventDefault();
                zoomOut();
            }
            // Ctrl/Cmd + 0: é‡ç½®ç¼©æ”¾
            else if ((e.ctrlKey || e.metaKey) && e.key === '0') {
                e.preventDefault();
                resetZoom();
            }
            // F11: å…¨å±æ¨¡å¼
            else if (e.key === 'F11') {
                e.preventDefault();
                toggleFullscreen();
            }
            // Ctrl/Cmd + D: å¤œé—´æ¨¡å¼
            else if ((e.ctrlKey || e.metaKey) && e.key === 'd') {
                e.preventDefault();
                toggleDarkMode();
            }
        });

        // é¡µé¢åˆ‡æ¢åŠŸèƒ½
        async function togglePage() {
            const btn = document.getElementById('pageToggleBtn');
            const isFullscreen = document.body.classList.contains('fullscreen-mode');
            const timeDisplay = document.querySelector('.time-display');
            const mainContent = document.getElementById('mainContent');
            
            if (currentPage === 'main') {
                // åˆ‡æ¢åˆ°åº§ä½å®‰æ’é¡µé¢
                currentPage = 'seating';
                mainContent.style.display = 'none';
                document.getElementById('seatingContent').style.display = 'block';
                
                // åœ¨å…¨å±æ¨¡å¼ä¸‹æ·»åŠ activeç±»å¹¶éšè—æ—¶é—´æ˜¾ç¤º
                if (isFullscreen) {
                    document.getElementById('seatingContent').classList.add('active');
                    timeDisplay.classList.add('hidden');
                }
                
                btn.innerHTML = '<i class="fas fa-bell"></i>';
                btn.title = 'è€ƒè¯•æ’­æŠ¥';
                btn.classList.add('active');
                
                // åŠ è½½åº§ä½å®‰æ’é…ç½®
                await loadSeatingConfig();
                
                // æ¢å¤ç­çº§å­¦ç”Ÿä¿¡æ¯
                loadClassStudentsFromStorage();
                
                // æ¢å¤è€ƒåœºä¿¡æ¯
                loadExamRoomFromStorage();
            } else {
                // åˆ‡æ¢å›è€ƒè¯•æ’­æŠ¥é¡µé¢
                currentPage = 'main';
                document.getElementById('seatingContent').style.display = 'none';
                
                // ç§»é™¤activeç±»
                document.getElementById('seatingContent').classList.remove('active');
                
                // åœ¨å…¨å±æ¨¡å¼ä¸‹ï¼Œä¸æ˜¾ç¤ºmain-contentï¼Œåªæ˜¾ç¤ºæ—¶é—´æ˜¾ç¤º
                if (isFullscreen) {
                    mainContent.style.display = 'none';
                    timeDisplay.classList.remove('hidden');
                    // ç¡®ä¿æ—¶é—´æ˜¾ç¤ºæ­£å¸¸æ›´æ–°
                    updateTime();
                } else {
                    // éå…¨å±æ¨¡å¼ä¸‹æ­£å¸¸æ˜¾ç¤ºmain-contentï¼Œç§»é™¤å†…è”æ ·å¼è®©CSSæ§åˆ¶å¸ƒå±€
                    mainContent.style.removeProperty('display');
                    // ç¡®ä¿æ—¶é—´æ˜¾ç¤ºæ­£å¸¸æ›´æ–°
                    updateTime();
                }
                
                btn.innerHTML = '<i class="fas fa-th"></i>';
                btn.title = 'è€ƒåœºå®‰æ’';
                btn.classList.remove('active');
            }
        }

        async function showSeatingPage() {
            currentPage = 'seating';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('seatingContent').style.display = 'block';
            
            // åŠ è½½åº§ä½å®‰æ’é…ç½®
            await loadSeatingConfig();
            
            // æ¢å¤ç­çº§å­¦ç”Ÿä¿¡æ¯
            loadClassStudentsFromStorage();
            
            // æ¢å¤è€ƒåœºä¿¡æ¯
            loadExamRoomFromStorage();
        }

        function showMainPage() {
            currentPage = 'main';
            document.getElementById('mainContent').style.removeProperty('display');
            document.getElementById('seatingContent').style.display = 'none';
        }

        // è€ƒåœºå®‰æ’ç›¸å…³å‡½æ•°
        async function loadSeatingConfig() {
            // é¦–å…ˆå°è¯•ä»students.jsonè‡ªåŠ¨åŠ è½½å­¦ç”Ÿæ•°æ®
            await loadStudentsFromFile();
            
            const saved = localStorage.getItem('seatingConfig');
            if (saved) {
                seatingConfig = { ...seatingConfig, ...JSON.parse(saved) };
                
                // æ¢å¤ç•Œé¢çŠ¶æ€
                if (seatingConfig.examRoom) {
                    document.getElementById('queryInput').value = seatingConfig.examRoom;
                    currentExamRoom = seatingConfig.examRoom;
                }
                
                if (seatingConfig.groupCount) {
                    document.getElementById('groupCount').value = seatingConfig.groupCount;
                }
                
                if (seatingConfig.groupSizes) {
                    document.getElementById('groupSizes').value = seatingConfig.groupSizes;
                }
            }
            
            // å¦‚æœè‡ªåŠ¨åŠ è½½å¤±è´¥ï¼Œå°è¯•ä»localStorageåŠ è½½å­¦ç”Ÿæ•°æ®
            if (studentsData.length === 0) {
                const savedStudents = localStorage.getItem('studentsData');
                if (savedStudents) {
                    studentsData = JSON.parse(savedStudents);
                }
            }
            
            updateSeatingArrangement();
        }

        // CSVè§£æå‡½æ•° - æ”¯æŒUTF-8ç¼–ç 
        function parseCSV(csvText) {
            // ç§»é™¤UTF-8 BOMæ ‡è®°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (csvText.charCodeAt(0) === 0xFEFF) {
                csvText = csvText.slice(1);
            }
            
            const lines = csvText.trim().split(/\r?\n/); // æ”¯æŒä¸åŒçš„æ¢è¡Œç¬¦
            if (lines.length < 2) return []; // è‡³å°‘éœ€è¦è¡¨å¤´å’Œä¸€è¡Œæ•°æ®
            
            // è§£æè¡¨å¤´
            const headers = parseCSVLine(lines[0]);
            
            // éªŒè¯å¿…è¦å­—æ®µ
            const requiredFields = ['å§“å', 'è€ƒåœº', 'åº§å·'];
            const missingFields = requiredFields.filter(field => !headers.includes(field));
            if (missingFields.length > 0) {
                console.error(`CSVæ–‡ä»¶ç¼ºå°‘å¿…è¦å­—æ®µ: ${missingFields.join(', ')}`);
                return [];
            }
            
            // è§£ææ•°æ®è¡Œ
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue; // è·³è¿‡ç©ºè¡Œ
                
                const values = parseCSVLine(line);
                if (values.length !== headers.length) {
                    console.warn(`ç¬¬${i + 1}è¡Œæ•°æ®åˆ—æ•°ä¸åŒ¹é…ï¼Œè·³è¿‡è¯¥è¡Œ`);
                    continue;
                }
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index];
                });
                
                data.push(row);
            }
            
            return data;
        }

        // è§£æCSVè¡Œï¼Œæ­£ç¡®å¤„ç†å¼•å·å’Œé€—å·
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        // è½¬ä¹‰çš„å¼•å·
                        current += '"';
                        i++; // è·³è¿‡ä¸‹ä¸€ä¸ªå¼•å·
                    } else {
                        // åˆ‡æ¢å¼•å·çŠ¶æ€
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // å­—æ®µåˆ†éš”ç¬¦
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            // æ·»åŠ æœ€åä¸€ä¸ªå­—æ®µ
            result.push(current.trim());
            
            return result;
        }

        // è‡ªåŠ¨åŠ è½½å­¦ç”Ÿæ•°æ®æ–‡ä»¶
        async function loadStudentsFromFile() {
            try {
                // é¦–å…ˆå°è¯•åŠ è½½ students.json
                let response = await fetch('./students.json');
                if (response.ok) {
                    const data = await response.json();
                    if (Array.isArray(data) && data.length > 0) {
                        studentsData = data;
                        // æ³¨é‡Šæ‰è‡ªåŠ¨ä¿å­˜åˆ°localStorageï¼Œæ”¹ä¸ºåªåœ¨è€ƒè¯•ç»“æŸåæ¢å¤
                        // localStorage.setItem('studentsData', JSON.stringify(studentsData));
                        
                        // é™é»˜åŠ è½½æˆåŠŸ
                        return;
                    }
                }
                
                // å¦‚æœ students.json ä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼Œå°è¯•åŠ è½½ students.csv
                response = await fetch('./students.csv');
                if (response.ok) {
                    const csvText = await response.text();
                    if (csvText.trim()) {
                        const data = parseCSV(csvText);
                        if (data.length > 0) {
                            studentsData = data;
                            // æ³¨é‡Šæ‰è‡ªåŠ¨ä¿å­˜åˆ°localStorageï¼Œæ”¹ä¸ºåªåœ¨è€ƒè¯•ç»“æŸåæ¢å¤
                            // localStorage.setItem('studentsData', JSON.stringify(studentsData));
                            
                            // é™é»˜åŠ è½½æˆåŠŸ
                            return;
                        }
                    }
                }
                
                // å¦‚æœä¸¤ç§æ–‡ä»¶éƒ½ä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼Œæç¤ºç”¨æˆ·æ‰‹åŠ¨å¯¼å…¥
                console.log('æœªæ‰¾åˆ° students.json æˆ– students.csv æ–‡ä»¶ï¼Œè¯·æ‰‹åŠ¨å¯¼å…¥Excelæ–‡ä»¶');
                
            } catch (error) {
                console.log('è‡ªåŠ¨åŠ è½½å­¦ç”Ÿæ•°æ®å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¯¼å…¥Excelæ–‡ä»¶:', error.message);
            }
        }

        function saveSeatingConfig() {
            localStorage.setItem('seatingConfig', JSON.stringify(seatingConfig));
        }

        function updateSeatingConfig() {
            seatingConfig.examRoom = currentExamRoom;
            seatingConfig.groupCount = parseInt(document.getElementById('groupCount').value) || 5;
            seatingConfig.groupSizes = document.getElementById('groupSizes').value || '6,6,6,6,6';
            saveSeatingConfig();
        }

        function saveSeatingResult(seatingGroups) {
            seatingConfig.seatingResult = seatingGroups;
            saveSeatingConfig();
        }

        function updateGroupSettings() {
            updateSeatingConfig();
            // æ£€æŸ¥å½“å‰æŸ¥è¯¢ç±»å‹ï¼Œåªæœ‰åœ¨è€ƒåœºæŸ¥è¯¢æ—¶æ‰æ›´æ–°åº§ä½å®‰æ’
            const queryType = document.getElementById('queryTypeSelect').value;
            if (queryType === 'examRoom') {
                updateSeatingArrangement();
            }
        }

        function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (jsonData.length === 0) {
                        showSeatingNotification('Excelæ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®', 'error');
                        return;
                    }
                    
                    // éªŒè¯å¿…è¦å­—æ®µ
                    const requiredFields = ['å§“å', 'è€ƒåœº', 'åº§å·'];
                    const firstRow = jsonData[0];
                    const missingFields = requiredFields.filter(field => !(field in firstRow));
                    
                    if (missingFields.length > 0) {
                        showSeatingNotification(`Excelæ–‡ä»¶ç¼ºå°‘å¿…è¦å­—æ®µ: ${missingFields.join(', ')}`, 'error');
                        return;
                    }
                    
                    // ä¿å­˜æ•°æ®åˆ°å†…å­˜ï¼Œä½†ä¸è‡ªåŠ¨ä¿å­˜åˆ°localStorage
                    studentsData = jsonData;
                    // æ‰‹åŠ¨å¯¼å…¥æ—¶ä»ç„¶ä¿å­˜åˆ°localStorageï¼Œä½†ä¼šåœ¨è€ƒè¯•ç»“æŸåæ¸…é™¤
                    localStorage.setItem('studentsData', JSON.stringify(studentsData));
                    localStorage.setItem('studentsDataImportTime', new Date().toISOString());
                    
                    // è·å–æ‰€æœ‰è€ƒåœº
                    const examRooms = [...new Set(studentsData.map(s => s['è€ƒåœº']).filter(Boolean))];
                    
                    showSeatingNotification(`æˆåŠŸå¯¼å…¥ ${studentsData.length} æ¡å­¦ç”Ÿæ•°æ®ï¼ŒåŒ…å« ${examRooms.length} ä¸ªè€ƒåœº`);
                    
                    // å¦‚æœåªæœ‰ä¸€ä¸ªè€ƒåœºï¼Œè‡ªåŠ¨å¡«å…¥
                    if (examRooms.length === 1) {
                        document.getElementById('queryInput').value = examRooms[0];
                        currentExamRoom = examRooms[0];
                        updateSeatingArrangement();
                    }
                    
                } catch (error) {
                    console.error('Excelè§£æé”™è¯¯:', error);
                    showSeatingNotification('Excelæ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        function clearStudentsData() {
            if (confirm(`ç¡®å®šè¦æ¸…é™¤å·²å¯¼å…¥çš„ ${studentsData.length} æ¡å­¦ç”Ÿæ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                studentsData = [];
                localStorage.removeItem('studentsData');
                
                document.getElementById('queryInput').value = '';
                currentExamRoom = '';
                
                seatingConfig.seatingResult = null;
                seatingConfig.examRoom = '';
                saveSeatingConfig();
                
                updateSeatingArrangement();
                showSeatingNotification('å­¦ç”Ÿæ•°æ®å·²æ¸…é™¤');
            }
        }

        function filterStudents() {
            const queryType = document.getElementById('queryTypeSelect').value;
            const queryValue = document.getElementById('queryInput').value.trim();
            
            if (queryType === 'examRoom') {
                currentExamRoom = queryValue;
                updateSeatingConfig();
                updateSeatingArrangement();
            } else if (queryType === 'class') {
                queryClassStudents(queryValue);
            }
        }

        function performQuery() {
            filterStudents();
        }

        function updateQueryType() {
            const queryType = document.getElementById('queryTypeSelect').value;
            const queryInput = document.getElementById('queryInput');
            
            if (queryType === 'examRoom') {
                queryInput.placeholder = 'å¦‚ï¼š101';
                // åˆ‡æ¢åˆ°è€ƒåœºæŸ¥è¯¢æ—¶ï¼Œå°è¯•æ¢å¤è€ƒåœºä¿¡æ¯
                const saved = localStorage.getItem('currentExamRoomInfo');
                if (saved) {
                    try {
                        const examRoomInfo = JSON.parse(saved);
                        queryInput.value = examRoomInfo.examRoom;
                        currentExamRoom = examRoomInfo.examRoom;
                        // æ¢å¤è€ƒåœºä¿¡æ¯å¹¶æ›´æ–°æ˜¾ç¤º
                        updateSeatingArrangement();
                        return;
                    } catch (error) {
                        console.error('æ¢å¤è€ƒåœºä¿¡æ¯å¤±è´¥:', error);
                    }
                }
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„è€ƒåœºä¿¡æ¯ï¼Œåˆ™æ¸…ç©º
                queryInput.value = '';
                currentExamRoom = '';
                updateSeatingArrangement();
            } else if (queryType === 'class') {
                queryInput.placeholder = 'å¦‚ï¼š1';
                // åˆ‡æ¢åˆ°ç­çº§æŸ¥è¯¢æ—¶ï¼Œå°è¯•æ¢å¤ç­çº§ä¿¡æ¯
                const saved = localStorage.getItem('currentClassStudents');
                if (saved) {
                    try {
                        const classInfo = JSON.parse(saved);
                        queryInput.value = classInfo.classNumber;
                        // æ¢å¤ç­çº§ä¿¡æ¯å¹¶æ›´æ–°æ˜¾ç¤º
                        loadClassStudentsFromStorage();
                        return;
                    } catch (error) {
                        console.error('æ¢å¤ç­çº§ä¿¡æ¯å¤±è´¥:', error);
                    }
                }
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„ç­çº§ä¿¡æ¯ï¼Œåˆ™æ¸…ç©º
                queryInput.value = '';
                const seatingArrangement = document.getElementById('seatingArrangement');
                seatingArrangement.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-users"></i>
                        <p>è¯·è¾“å…¥ç­çº§å·</p>
                    </div>
                `;
            }
        }

        function queryClassStudents(classNumber) {
            if (!studentsDataã€‚length) {
                showSeatingNotification('è¯·å…ˆå¯¼å…¥å­¦ç”Ÿæ•°æ®'ï¼Œ 'error');
                return;
            }
            
            if (!classNumber) {
                // æ¸…ç©ºåº§ä½å®‰æ’æ˜¾ç¤º
                const seatingArrangement = documentã€‚getElementById('seatingArrangement');
                seatingArrangement.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-users"></i>
                        <p>è¯·è¾“å…¥ç­çº§å·</p>
                    </div>
                `;
                document.getElementById('seatingStats').innerHTML = '';
                // æ¸…ç©ºæœ¬åœ°å­˜å‚¨çš„ç­çº§ä¿¡æ¯
                localStorageã€‚removeItem('currentClassStudents');
                return;
            }
            
            // æŸ¥æ‰¾ç­çº§å­¦ç”Ÿï¼ˆæ”¯æŒå¤šç§ç­çº§æ ¼å¼ï¼‰
            const classStudents = studentsData.filter(student => {
                const studentClass = student['ç­çº§'];
                if (!studentClass) return false;
                
                // æå–ç­çº§ä¸­çš„æ•°å­—
                const classMatch = studentClassã€‚toString()ã€‚match(/(\d+)/);
                if (classMatch) {
                    return classMatch[1] === classNumber.toString();
                }
                return false;
            });
            
            if (classStudents.length === 0) {
                const seatingArrangement = documentã€‚getElementById('seatingArrangement');
                seatingArrangement.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>æœªæ‰¾åˆ°ç­çº§ ${classNumber} çš„å­¦ç”Ÿä¿¡æ¯</p>
                    </div>
                `;
                document.getElementById('seatingStats')ã€‚innerHTML = '';
                // æ¸…ç©ºæœ¬åœ°å­˜å‚¨çš„ç­çº§ä¿¡æ¯
                localStorage.removeItem('currentClassStudents');
                return;
            }
            
            // æŒ‰ç­çº§åº§å·æ’åº
            classStudents.sort((a, b) => {
                const seatA = parseInt(a['ç­çº§åº§å·'] || a['åº§å·'] || a['åº§ä½å·'] || 0);
                const seatB = parseInt(b['ç­çº§åº§å·'] || b['åº§å·'] || b['åº§ä½å·'] || 0);
                return seatA - seatB;
            });
            
            // ä¿å­˜ç­çº§å­¦ç”Ÿä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨
            const classInfo = {
                classNumber: classNumberï¼Œ
                students: classStudentsï¼Œ
                timestamp: new Date()ã€‚toISOString()
            };
            localStorage.setItem('currentClassStudents', JSON.stringify(classInfo));
            
            // ç›´æ¥æ˜¾ç¤ºæ‰€æœ‰å­¦ç”Ÿä¿¡æ¯ï¼Œä¸æŒ‰ç»„æ•°åˆ†ç»„
            const seatingArrangement = document.getElementById('seatingArrangement');
            let html = '<div class="class-students-grid">';
            
            classStudents.forEach(student => {
                const classSeatNumber = student['ç­çº§åº§å·'] || student['åº§å·'] || student['åº§ä½å·'] || '';
                html += `
                    <div class="class-student-item">
                        ${classSeatNumber ? `<span class="class-seat-number">${classSeatNumber}</span>` : ''}
                        <span class="student-name">${student['å§“å'] || 'æœªçŸ¥'}</span>
                        <span class="exam-seat">${student['è€ƒåœº'] || 'æœªçŸ¥'}-${student['åº§å·'] || student['åº§ä½å·'] || 'æœªçŸ¥'}</span>
                    </div>
                `;
            });
            
            html += '</div>';
            seatingArrangement.innerHTML = html;
        }

        // ä»æœ¬åœ°å­˜å‚¨æ¢å¤ç­çº§å­¦ç”Ÿä¿¡æ¯
        function loadClassStudentsFromStorage() {
            const saved = localStorage.getItem('currentClassStudents');
            if (!saved) return;
            
            try {
                const classInfo = JSON.parse(saved);
                
                // æ£€æŸ¥æ•°æ®æ˜¯å¦è¿‡æœŸï¼ˆ24å°æ—¶ï¼‰
                const savedTime = new Date(classInfo.timestamp);
                const now = new Date();
                const hoursDiff = (now - savedTime) / (1000 * 60 * 60);
                
                if (hoursDiff > 24) {
                    localStorage.removeItem('currentClassStudents');
                    return;
                }
                
                // å¦‚æœæœ‰å­¦ç”Ÿæ•°æ®ï¼Œæ¢å¤æ˜¾ç¤º
                if (classInfo.students && classInfo.students.length > 0) {
                    // è®¾ç½®ç­çº§å·è¾“å…¥æ¡†
                    const classInput = document.getElementById('classNumber');
                    if (classInput) {
                        classInput.value = classInfo.classNumber;
                    }
                    
                    // è®¾ç½®æŸ¥è¯¢è¾“å…¥æ¡†
                    const queryInput = document.getElementById('queryInput');
                    if (queryInput) {
                        queryInput.value = classInfo.classNumber;
                    }
                    
                    // ç¡®ä¿æŸ¥è¯¢ç±»å‹è®¾ç½®ä¸ºç­çº§
                    const queryTypeSelect = document.getElementById('queryTypeSelect');
                    if (queryTypeSelect) {
                        queryTypeSelect.value = 'class';
                    }
                    
                    // æ¢å¤æ˜¾ç¤º
                    const seatingArrangement = document.getElementById('seatingArrangement');
                    let html = '<div class="class-students-grid">';
                    
                    classInfo.students.forEach(student => {
                        const classSeatNumber = student['ç­çº§åº§å·'] || student['åº§å·'] || student['åº§ä½å·'] || '';
                        html += `
                            <div class="class-student-item">
                                ${classSeatNumber ? `<span class="class-seat-number">${classSeatNumber}</span>` : ''}
                                <span class="student-name">${student['å§“å'] || 'æœªçŸ¥'}</span>
                                <span class="exam-seat">${student['è€ƒåœº'] || 'æœªçŸ¥'}-${student['åº§å·'] || student['åº§ä½å·'] || 'æœªçŸ¥'}</span>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    seatingArrangement.innerHTML = html;
                    
                    // showSeatingNotification(`å·²æ¢å¤ç­çº§ ${classInfo.classNumber} çš„å­¦ç”Ÿä¿¡æ¯`, 'success');
                }
            } catch (error) {
                console.error('æ¢å¤ç­çº§ä¿¡æ¯å¤±è´¥:', error);
                localStorage.removeItem('currentClassStudents');
            }
        }

        // ä»æœ¬åœ°å­˜å‚¨æ¢å¤è€ƒåœºä¿¡æ¯
        function loadExamRoomFromStorage() {
            const saved = localStorage.getItem('currentExamRoomInfo');
            if (!saved) return;
            
            try {
                const examRoomInfo = JSON.parse(saved);
                
                // æ£€æŸ¥æ•°æ®æ˜¯å¦è¿‡æœŸï¼ˆ24å°æ—¶ï¼‰
                const savedTime = new Date(examRoomInfo.timestamp);
                const now = new Date();
                const hoursDiff = (now - savedTime) / (1000 * 60 * 60);
                
                if (hoursDiff > 24) {
                    localStorage.removeItem('currentExamRoomInfo');
                    return;
                }
                
                // å¦‚æœæœ‰è€ƒåœºæ•°æ®ï¼Œæ¢å¤æ˜¾ç¤º
                if (examRoomInfo.examRoom && examRoomInfo.students && examRoomInfo.students.length > 0) {
                    // è®¾ç½®æŸ¥è¯¢è¾“å…¥æ¡†
                    const queryInput = document.getElementById('queryInput');
                    if (queryInput) {
                        queryInput.value = examRoomInfo.examRoom;
                    }
                    
                    // ç¡®ä¿æŸ¥è¯¢ç±»å‹è®¾ç½®ä¸ºè€ƒåœº
                    const queryTypeSelect = document.getElementById('queryTypeSelect');
                    if (queryTypeSelect) {
                        queryTypeSelect.value = 'examRoom';
                    }
                    
                    // è®¾ç½®å½“å‰è€ƒåœº
                    currentExamRoom = examRoomInfo.examRoom;
                    
                    // æ¢å¤åº§ä½å®‰æ’æ˜¾ç¤º
                    const groupCount = parseInt(document.getElementById('groupCount').value) || 5;
                    const groupSizesInput = document.getElementById('groupSizes').value.trim();
                    let groupSizes = [];
                    
                    if (groupSizesInput) {
                        groupSizes = groupSizesInput.split(',').map(size => parseInt(size.trim()) || 6);
                        while (groupSizes.length < groupCount) {
                            groupSizes.push(6);
                        }
                        groupSizes = groupSizes.slice(0, groupCount);
                    } else {
                        for (let i = 0; i < groupCount; i++) {
                            groupSizes.push(6);
                        }
                    }
                    
                    const seatingGroups = generateSShapeArrangementWithCustomSizes(examRoomInfo.students, groupSizes);
                    renderSeatingArrangement(seatingGroups);
                    
                    // showSeatingNotification(`å·²æ¢å¤è€ƒåœº ${examRoomInfo.examRoom} çš„åº§ä½å®‰æ’`, 'success');
                }
            } catch (error) {
                console.error('æ¢å¤è€ƒåœºä¿¡æ¯å¤±è´¥:', error);
                localStorage.removeItem('currentExamRoomInfo');
            }
        }

        function updateSeatingArrangement() {
            const seatingArrangement = document.getElementById('seatingArrangement');
            const seatingStats = document.getElementById('seatingStats');
            
            if (!studentsData.length || !currentExamRoom) {
                seatingArrangement.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-users"></i>
                        <p>${!studentsData.length ? 'è¯·å…ˆå¯¼å…¥Excelæ–‡ä»¶' : 'è¯·è¾“å…¥è€ƒåœºå·'}</p>
                    </div>
                `;
                seatingStats.innerHTML = '';
                // æ¸…ç©ºè€ƒåœºä¿¡æ¯å­˜å‚¨
                localStorage.removeItem('currentExamRoomInfo');
                return;
            }
            
            const roomStudents = studentsData.filter(student => 
                student['è€ƒåœº'] && student['è€ƒåœº'].toString() === currentExamRoom
            );
            
            if (roomStudents.length === 0) {
                seatingArrangement.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>è€ƒåœº ${currentExamRoom} æ²¡æœ‰æ‰¾åˆ°å­¦ç”Ÿæ•°æ®</p>
                    </div>
                `;
                seatingStats.innerHTML = '';
                // æ¸…ç©ºè€ƒåœºä¿¡æ¯å­˜å‚¨
                localStorage.removeItem('currentExamRoomInfo');
                return;
            }
            
            roomStudents.sort((a, b) => {
                const seatA = parseInt(a['åº§å·']) || 0;
                const seatB = parseInt(b['åº§å·']) || 0;
                return seatA - seatB;
            });
            
            const groupCount = parseInt(document.getElementById('groupCount').value) || 5;
            const groupSizesInput = document.getElementById('groupSizes').value.trim();
            let groupSizes = [];
            
            if (groupSizesInput) {
                groupSizes = groupSizesInput.split(',').map(size => parseInt(size.trim()) || 6);
                while (groupSizes.length < groupCount) {
                    groupSizes.push(6);
                }
                groupSizes = groupSizes.slice(0, groupCount);
            } else {
                for (let i = 0; i < groupCount; i++) {
                    groupSizes.push(6);
                }
            }
            
            const seatingGroups = generateSShapeArrangementWithCustomSizes(roomStudents, groupSizes);
            saveSeatingResult(seatingGroups);
            seatingStats.innerHTML = '';
            renderSeatingArrangement(seatingGroups);
            
            // ä¿å­˜è€ƒåœºä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨
            const examRoomInfo = {
                examRoom: currentExamRoom,
                students: roomStudents,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('currentExamRoomInfo', JSON.stringify(examRoomInfo));
        }

        function generateSShapeArrangementWithCustomSizes(students, groupSizes) {
            const groups = [];
            let studentIndex = 0;
            
            for (let groupIndex = 0; groupIndex < groupSizes.length && studentIndex < students.length; groupIndex++) {
                const group = {
                    id: groupIndex + 1,
                    students: []
                };
                
                const currentGroupSize = Math.min(groupSizes[groupIndex], students.length - studentIndex);
                const groupStudents = students.slice(studentIndex, studentIndex + currentGroupSize);
                
                if (groupIndex % 2 === 0) {
                    group.students = groupStudents;
                } else {
                    group.students = groupStudents.reverse();
                }
                
                groups.push(group);
                studentIndex += currentGroupSize;
            }
            
            return groups;
        }

        function renderSeatingArrangement(groups) {
            const seatingArrangement = document.getElementById('seatingArrangement');
            
            let html = '<div class="seating-grid">';
            
            groups.forEach(group => {
                html += `
                    <div class="seating-group">
                        <div class="group-header">ç¬¬ ${group.id} ç»„</div>
                        <div class="seats-container">
                `;
                
                group.students.forEach(student => {
                    html += `
                        <div class="seat">
                            <div class="seat-number">${student['åº§å·'] || 'æœªçŸ¥'}</div>
                            <div class="student-name">${student['å§“å'] || 'æœªçŸ¥'}</div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            seatingArrangement.innerHTML = html;
        }

        function showSeatingNotification(message, type = 'success') {
            const existingNotification = document.querySelector('.seating-notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `seating-notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // é”å®šåŠŸèƒ½ç›¸å…³å˜é‡å’Œå‡½æ•°
        let isLocked = true; // é»˜è®¤é”å®šçŠ¶æ€
        const unlockPassword = '456123'; // é»˜è®¤å¯†ç 

        // åˆå§‹åŒ–é”å®šçŠ¶æ€
        function initializeLockState() {
            updateLockState();
        }

        // æ›´æ–°é”å®šçŠ¶æ€
        function updateLockState() {
            const lockBtn = document.getElementById('lockBtn');
            const lockIcon = lockBtn.querySelector('i');
            
            // è·å–æ‰€æœ‰éœ€è¦é”å®šçš„æŒ‰é’®ï¼ˆé™¤äº†åŒå‘åˆ‡æ¢ã€å¸®åŠ©ã€å…¨å±ã€å¤œé—´æ¨¡å¼ã€ç¼©æ”¾å’Œé”å®šæŒ‰é’®æœ¬èº«ï¼‰
            const buttonsToLock = document.querySelectorAll('.control-btn:not(#pageToggleBtn):not(#lockBtn)');
            const helpBtn = document.querySelector('.control-btn[onclick="showHelp()"]');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const darkModeBtn = document.getElementById('darkModeBtn');
            const zoomInBtn = document.querySelector('.control-btn[onclick="zoomIn()"]');
            const zoomOutBtn = document.querySelector('.control-btn[onclick="zoomOut()"]');
            
            // è·å–å¯¼å…¥é…ç½®æŒ‰é’®ï¼ˆlabelå…ƒç´ ï¼‰å’Œå…¶å†…éƒ¨çš„æ–‡ä»¶è¾“å…¥
            const importConfigLabel = document.querySelector('label.control-btn[title="å¯¼å…¥é…ç½®"]');
            const importConfigInput = importConfigLabel ? importConfigLabel.querySelector('input[type="file"]') : null;
            
            // è·å–è€ƒè¯•ç®¡ç†å’Œæé†’è®¾ç½®ä¸­çš„æ‰€æœ‰æŒ‰é’®
            const examManagementButtons = document.querySelectorAll('.btn[onclick*="Exam"], .btn[onclick*="addExam"], .btn[onclick*="editExam"], .btn[onclick*="deleteExam"]');
            const reminderManagementButtons = document.querySelectorAll('.btn[onclick*="Reminder"], .btn[onclick*="addReminder"], .btn[onclick*="editReminder"], .btn[onclick*="deleteReminder"], .btn[onclick*="toggleReminder"]');
            
            // è·å–åº§ä½å®‰æ’ä¸­çš„å¯¼å…¥æ•°æ®å’Œæ¸…é™¤æ•°æ®æŒ‰é’®
            const seatingImportBtn = document.querySelector('.import-btn');
            const seatingClearBtn = document.querySelector('.clear-data-btn');
            
            if (isLocked) {
                // é”å®šçŠ¶æ€
                lockIcon.className = 'fas fa-lock';
                lockBtn.title = 'è§£é”';
                
                // é”å®šé™¤äº†åŒå‘åˆ‡æ¢ã€å¸®åŠ©ã€å…¨å±ã€å¤œé—´æ¨¡å¼ã€ç¼©æ”¾æŒ‰é’®å¤–çš„æ‰€æœ‰æŒ‰é’®
                buttonsToLock.forEach(btn => {
                    if (btn !== helpBtn && btn !== fullscreenBtn && btn !== darkModeBtn && btn !== zoomInBtn && btn !== zoomOutBtn && btn !== importConfigLabel) {
                        btn.style.opacity = '0.5';
                        btn.style.cursor = 'not-allowed';
                        btn.style.pointerEvents = 'none';
                    }
                });
                
                // ç‰¹åˆ«å¤„ç†å¯¼å…¥é…ç½®æŒ‰é’®
                if (importConfigLabel) {
                    importConfigLabel.style.opacity = '0.5';
                    importConfigLabel.style.cursor = 'not-allowed';
                    importConfigLabel.style.pointerEvents = 'none';
                }
                if (importConfigInput) {
                    importConfigInput.disabled = true;
                }
                
                // é”å®šè€ƒè¯•ç®¡ç†æŒ‰é’®
                examManagementButtons.forEach(btn => {
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                    btn.style.pointerEvents = 'none';
                });
                
                // é”å®šæé†’è®¾ç½®æŒ‰é’®
                reminderManagementButtons.forEach(btn => {
                    btn.style.opacity = '0.5';
                    btn.style.cursor = 'not-allowed';
                    btn.style.pointerEvents = 'none';
                });
                
                // é”å®šåº§ä½å®‰æ’æŒ‰é’®
                if (seatingImportBtn) {
                    seatingImportBtn.style.opacity = '0.5';
                    seatingImportBtn.style.cursor = 'not-allowed';
                    seatingImportBtn.style.pointerEvents = 'none';
                }
                if (seatingClearBtn) {
                    seatingClearBtn.style.opacity = '0.5';
                    seatingClearBtn.style.cursor = 'not-allowed';
                    seatingClearBtn.style.pointerEvents = 'none';
                }
            } else {
                // è§£é”çŠ¶æ€
                lockIcon.className = 'fas fa-unlock';
                lockBtn.title = 'é”å®š';
                
                // è§£é”æ‰€æœ‰æŒ‰é’®
                buttonsToLock.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '';
                    btn.style.cursor = '';
                    btn.style.pointerEvents = '';
                });
                
                // ç‰¹åˆ«å¤„ç†å¯¼å…¥é…ç½®æŒ‰é’®
                if (importConfigLabel) {
                    importConfigLabel.style.opacity = '';
                    importConfigLabel.style.cursor = '';
                    importConfigLabel.style.pointerEvents = '';
                }
                if (importConfigInput) {
                    importConfigInput.disabled = false;
                }
                
                // è§£é”è€ƒè¯•ç®¡ç†æŒ‰é’®
                examManagementButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '';
                    btn.style.cursor = '';
                    btn.style.pointerEvents = '';
                });
                
                // è§£é”æé†’è®¾ç½®æŒ‰é’®
                reminderManagementButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '';
                    btn.style.cursor = '';
                    btn.style.pointerEvents = '';
                });
                
                // è§£é”åº§ä½å®‰æ’æŒ‰é’®
                if (seatingImportBtn) {
                    seatingImportBtn.style.opacity = '';
                    seatingImportBtn.style.cursor = '';
                    seatingImportBtn.style.pointerEvents = '';
                }
                if (seatingClearBtn) {
                    seatingClearBtn.disabled = false;
                    seatingClearBtn.style.opacity = '';
                    seatingClearBtn.style.cursor = '';
                    seatingClearBtn.style.pointerEvents = '';
                }
            }
        }

        // åˆ‡æ¢é”å®šçŠ¶æ€
        function toggleLock() {
            if (isLocked) {
                // å½“å‰æ˜¯é”å®šçŠ¶æ€ï¼Œéœ€è¦è¾“å…¥å¯†ç è§£é”
                const inputPassword = prompt('è¯·è¾“å…¥è§£é”å¯†ç ï¼š');
                if (inputPassword === unlockPassword) {
                    isLocked = false;
                    updateLockState();
                    showNotification('å·²è§£é”', 'success');
                } else if (inputPassword !== null) {
                    showNotification('å¯†ç é”™è¯¯', 'error');
                }
            } else {
                // å½“å‰æ˜¯è§£é”çŠ¶æ€ï¼Œç›´æ¥é”å®š
                isLocked = true;
                updateLockState();
                showNotification('å·²é”å®š', 'success');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–é”å®šçŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿æ‰€æœ‰æŒ‰é’®éƒ½å·²åŠ è½½
            setTimeout(initializeLockState, 100);
        });

        // æ£€æŸ¥æœ¬åœºå…¨éƒ¨è€ƒè¯•æ˜¯å¦å·²ç»“æŸ
        function checkAllExamsEndedForToday(endedExam) {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const allInstances = getAllExamInstances();
            
            // è·å–ä»Šå¤©çš„æ‰€æœ‰è€ƒè¯•
            const todayExams = allInstances.filter(exam => exam.date === today);
            
            if (todayExamsã€‚length === 0) {
                return; // ä»Šå¤©æ²¡æœ‰è€ƒè¯•
            }
            
            // æ£€æŸ¥ä»Šå¤©æ‰€æœ‰è€ƒè¯•æ˜¯å¦éƒ½å·²ç»“æŸ
            const allExamsEnded = todayExamsã€‚every(exam => {
                const examStart = new Date(`${exam.date} ${exam.startTime}`);
                const examEnd = new Date(examStartã€‚getTime() + exam.duration * 60000);
                return å½“å‰ >= examEnd;
            });
            
            if (allExamsEnded) {
                consoleã€‚log('æœ¬åœºå…¨éƒ¨è€ƒè¯•å·²ç»“æŸï¼Œå‡†å¤‡æ¢å¤åº§ä½å®‰æ’æ•°æ®');
                restoreSeatingDataAfterExams();
            }
        }

        // åœ¨è€ƒè¯•å…¨éƒ¨ç»“æŸåæ¢å¤åº§ä½å®‰æ’æ•°æ®
        function restoreSeatingDataAfterExams() {
            const savedData = localStorage.getItem('studentsData');
            const importTime = localStorageã€‚getItem('studentsDataImportTime');
            
            if (savedData && importTime) {
                try {
                    const data = JSON.parse(savedData);
                    const importDate = new Date(importTime);
                    const å½“å‰ = new Date();
                    
                    // æ£€æŸ¥æ•°æ®æ˜¯å¦æ˜¯ä»Šå¤©å¯¼å…¥çš„
                    const isToday = importDate.toDateString() === å½“å‰.toDateString();
                    
                    if (isToday && Arrayã€‚isArray(data) && data.length > 0) {
                        studentsData = data;
                        showSeatingNotification(`è€ƒè¯•ç»“æŸï¼Œå·²æ¢å¤è€ƒåœºå®‰æ’æ•°æ®ï¼š${dataã€‚length} æ¡å­¦ç”Ÿè®°å½•`);
                        
                        // å¦‚æœå½“å‰åœ¨åº§ä½å®‰æ’é¡µé¢ï¼Œæ›´æ–°æ˜¾ç¤º
                        if (documentã€‚bodyã€‚classListã€‚contains('seating-page')) {
                            updateSeatingArrangement();
                        }
                        
                        console.log('åº§ä½å®‰æ’æ•°æ®å·²æ¢å¤');
                    } else {
                        consoleã€‚log('åº§ä½å®‰æ’æ•°æ®ä¸æ˜¯ä»Šå¤©å¯¼å…¥çš„ï¼Œä¸è¿›è¡Œæ¢å¤');
                    }
                } catch (error) {
                    console.error('æ¢å¤åº§ä½å®‰æ’æ•°æ®å¤±è´¥:', error);
                }
            } else {
                consoleã€‚log('æ²¡æœ‰æ‰¾åˆ°éœ€è¦æ¢å¤çš„åº§ä½å®‰æ’æ•°æ®');
            }
        }
    </script>
    
    <!-- å¼•å…¥XLSXåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>
